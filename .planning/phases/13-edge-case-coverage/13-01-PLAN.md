---
phase: 13
plan: 01
title: Edge Case Coverage for Auto-Committer
created: 2026-01-29
---

# Plan 13-01: Edge Case Coverage for Auto-Committer

**Goal:** Improve emergency/auto_committer.py coverage from 82% to 95%

**Current Coverage:** 82% (Phase 10 baseline)
**Target Coverage:** 95%
**Missing Coverage:** ~13% (git error paths, edge cases, exception handling)

**Context:** Phase 12 addressed all critical modules below 80%. Phase 13 targets the highest-priority module in the 80-89% range (auto_committer.py) to further improve overall project quality.

---

## TDD Strategy

Follow strict RED-GREEN-REFACTOR for all new tests:

1. **RED:** Analyze coverage report to identify uncovered lines
2. **GREEN:** Write unit test for uncovered error path
3. **REFACTOR:** Verify test passes against existing implementation

**Test-First Order:**
1. Run coverage report to identify specific uncovered lines
2. Write unit tests for uncovered git error paths and edge cases
3. Verify tests pass (code already implements error handling)
4. Run coverage report to confirm 95%+ achievement

---

## Coverage Gap Analysis

### Uncovered Scenarios (Estimated)

Based on code analysis of auto_committer.py:

**Line 87-93:** Git add failure path
- `if add_process.returncode != 0:` - covered
- Early return and logging - likely uncovered

**Line 105-118:** Git commit failure scenarios
- `if commit_process.returncode == 0:` success path - covered
- `else:` failure path - likely partially covered
- stderr decoding edge case - likely uncovered

**Line 120-125:** Exception handling
- Generic exception catch - likely uncovered
- Error logging - likely uncovered

**Line 38-42:** File list formatting edge cases
- `len(files) == 1` - covered
- `len(files) <= 3` - covered
- `len(files) > 3` with "and X more" - potentially uncovered

---

## Tasks

### Task 1: Run Coverage Report for Auto-Committer

**Goal:** Identify exact uncovered lines

**Command:**
```bash
pytest tests/test_emergency_auto_committer.py \
  --cov=src/emergency/auto_committer \
  --cov-report=term-missing
```

**Expected Output:**
- Current coverage: 82%
- List of uncovered line numbers
- Missing scenarios identification

**Files:**
- Run: Coverage analysis

**Success Criteria:**
- Exact uncovered lines identified
- Missing scenarios documented

---

### Task 2: Add Test for Git Add Failure

**Scenario:** `git add` returns non-zero exit code

**Test:** `test_auto_commit_git_add_failure`

**What to Test:**
- Mock `git add` to return returncode=1
- Verify auto_commit returns early (no commit attempted)
- Verify warning logged with returncode

**Code Pattern:**
```python
@pytest.mark.asyncio
async def test_auto_commit_git_add_failure(auto_committer, emergency_mode):
    """Test auto-commit when git add fails."""
    await emergency_mode.activate("thread-123")

    with (
        patch("asyncio.create_subprocess_exec", new_callable=AsyncMock) as mock_exec,
        tempfile.TemporaryDirectory() as tmpdir,
    ):
        # Mock git add failure
        mock_process = AsyncMock()
        mock_process.communicate = AsyncMock(return_value=(b"", b"error"))
        mock_process.returncode = 1  # Non-zero = failure
        mock_exec.return_value = mock_process

        await auto_committer.auto_commit(
            emergency_mode=emergency_mode,
            session_id="test-session",
            project_path=tmpdir,
            operation="Edit",
            files=["test.py"],
        )

        # Should only call git add (no commit)
        assert mock_exec.call_count == 1

        # Verify git add was called
        mock_exec.assert_called_once()
        assert "git" in mock_exec.call_args[0]
        assert "add" in mock_exec.call_args[0]
```

**Target Lines:** ~87-93 (git add failure path)

**Files:**
- Edit: `tests/test_emergency_auto_committer.py` (add 1 test)

**Success Criteria:**
- Test passes
- Coverage for git add failure path increases

---

### Task 3: Add Test for Git Commit Failure

**Scenario:** `git commit` returns non-zero exit code

**Test:** `test_auto_commit_git_commit_failure`

**What to Test:**
- Mock `git add` success, `git commit` failure
- Verify warning logged with stderr output
- Verify returncode captured

**Code Pattern:**
```python
@pytest.mark.asyncio
async def test_auto_commit_git_commit_failure(auto_committer, emergency_mode):
    """Test auto-commit when git commit fails."""
    await emergency_mode.activate("thread-123")

    with (
        patch("asyncio.create_subprocess_exec", new_callable=AsyncMock) as mock_exec,
        tempfile.TemporaryDirectory() as tmpdir,
    ):
        # Mock git add success, git commit failure
        add_process = AsyncMock()
        add_process.communicate = AsyncMock(return_value=(b"", b""))
        add_process.returncode = 0

        commit_process = AsyncMock()
        commit_process.communicate = AsyncMock(
            return_value=(b"", b"nothing to commit, working tree clean")
        )
        commit_process.returncode = 1

        mock_exec.side_effect = [add_process, commit_process]

        await auto_committer.auto_commit(
            emergency_mode=emergency_mode,
            session_id="test-session",
            project_path=tmpdir,
            operation="Edit",
            files=["test.py"],
        )

        # Should call git add and git commit
        assert mock_exec.call_count == 2
```

**Target Lines:** ~112-118 (git commit failure path)

**Files:**
- Edit: `tests/test_emergency_auto_committer.py` (add 1 test)

**Success Criteria:**
- Test passes
- Coverage for git commit failure path increases

---

### Task 4: Add Test for Exception During Auto-Commit

**Scenario:** Exception raised during subprocess execution

**Test:** `test_auto_commit_subprocess_exception`

**What to Test:**
- Mock subprocess to raise OSError or similar
- Verify exception caught and logged
- Verify function doesn't crash

**Code Pattern:**
```python
@pytest.mark.asyncio
async def test_auto_commit_subprocess_exception(auto_committer, emergency_mode):
    """Test auto-commit handles subprocess exceptions gracefully."""
    await emergency_mode.activate("thread-123")

    with (
        patch("asyncio.create_subprocess_exec", new_callable=AsyncMock) as mock_exec,
        tempfile.TemporaryDirectory() as tmpdir,
    ):
        # Mock subprocess to raise exception
        mock_exec.side_effect = OSError("git not found")

        # Should not crash
        await auto_committer.auto_commit(
            emergency_mode=emergency_mode,
            session_id="test-session",
            project_path=tmpdir,
            operation="Edit",
            files=["test.py"],
        )

        # Exception was handled (no crash)
        assert True
```

**Target Lines:** ~120-125 (exception handling)

**Files:**
- Edit: `tests/test_emergency_auto_committer.py` (add 1 test)

**Success Criteria:**
- Test passes
- Coverage for exception handling increases

---

### Task 5: Add Test for Many Files (4+ Files)

**Scenario:** Commit message truncation for 4+ files

**Test:** `test_format_commit_message_many_files`

**What to Test:**
- Pass 5 files to format_commit_message
- Verify first 3 files listed
- Verify "and 2 more" appended

**Code Pattern:**
```python
def test_format_commit_message_many_files(auto_committer):
    """Test commit message truncates file list for 4+ files."""
    message = auto_committer.format_commit_message(
        session_id="test-session-123",
        operation="Edit",
        files=["file1.py", "file2.py", "file3.py", "file4.py", "file5.py"],
    )

    # First 3 files listed
    assert "file1.py" in message
    assert "file2.py" in message
    assert "file3.py" in message

    # Remaining files indicated with count
    assert "and 2 more" in message

    # Not all files individually listed
    assert "file4.py" not in message
    assert "file5.py" not in message
```

**Target Lines:** ~42 (file list truncation with "and X more")

**Files:**
- Edit: `tests/test_emergency_auto_committer.py` (add 1 test)

**Success Criteria:**
- Test passes
- Coverage for file list truncation increases

---

### Task 6: Verify Coverage Improvements

**Run Full Coverage Report:**

```bash
pytest tests/test_emergency_auto_committer.py \
  --cov=src/emergency/auto_committer \
  --cov-report=term-missing \
  --cov-report=html
```

**Validate Improvements:**
- auto_committer.py: ≥95% (from 82%)
- New tests added: 4-5 tests
- All existing tests still pass

**Commit Coverage Report:**

```bash
git add tests/test_emergency_auto_committer.py
git commit -m "test(13-01): improve auto_committer coverage from 82% to 95%

Added 4-5 unit tests covering:
- Git add failure path (returncode != 0)
- Git commit failure path with stderr
- Exception handling during subprocess execution
- File list truncation for 4+ files

Coverage: 82% → 95%
All tests pass, no regressions.

Generated with [Claude Code](https://claude.ai/code)
via [Happy](https://happy.engineering)

Co-Authored-By: Claude <noreply@anthropic.com>
Co-Authored-By: Happy <yesreply@happy.engineering>"
```

**Files:**
- Read: Coverage reports (HTML and terminal output)
- Verify: auto_committer.py ≥95%
- Verify: All existing tests pass

**Success Criteria:**
- auto_committer.py coverage ≥95%
- 4-5 new tests passing
- Coverage report committed
- No test failures

---

## Dependencies

**Depends On:**
- Phase 10 (Testing & Quality) - test infrastructure exists
- Phase 12 (Test Coverage Improvement) - pattern established

**Blocks:**
- None (quality improvement, not functional requirement)

**External Dependencies:**
- pytest-cov (already installed)
- Coverage.py (already configured)

---

## Verification Criteria

After completing this plan:

- [ ] auto_committer.py coverage ≥95% (from 82%)
- [ ] 4-5 new unit tests added
- [ ] All existing tests still pass (no regressions)
- [ ] Git add failure path covered
- [ ] Git commit failure path covered
- [ ] Exception handling path covered
- [ ] File list truncation (4+ files) covered
- [ ] Coverage report committed to repository
- [ ] HTML coverage report generated for analysis

**Expected Outcome:**
- auto_committer.py meets 95% coverage target
- All git error paths validated
- Exception handling tested
- Edge cases (file truncation) covered
- Improved debugging and regression detection

---

## Notes

**Why This Module:**

- Highest priority in 80-89% range (82%)
- Critical for emergency mode functionality
- Git operations have multiple failure modes
- Error handling paths currently untested

**What We're Testing:**

- Git command failure scenarios (add, commit)
- Exception handling during subprocess execution
- Edge cases (4+ files, stderr decoding)
- NOT testing happy paths (already covered at 82%)

**95% Target Rationale:**

- 82% → 95% represents ~13% improvement
- Estimated 4-5 tests to cover remaining gaps
- Aligns with Phase 12 quality standards
- Brings module from "good" to "excellent" tier

**Estimated Time:** 30-45 minutes (4-5 tests, straightforward mocking)

---

_Created: 2026-01-29_
_Phase: 13 (Edge Case Coverage)_
_Priority: Quality Enhancement (Optional for v1.0)_
