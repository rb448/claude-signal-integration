---
phase: 03-claude-integration
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified: [src/claude/responder.py, tests/test_claude_responder.py]
autonomous: true

must_haves:
  truths:
    - "Tool calls appear in Signal messages ('Read: file.py')"
    - "Progress updates appear in Signal ('Analyzing code...')"
    - "Error messages appear in Signal ('Error: Failed')"
    - "Long responses split across multiple Signal messages"
  artifacts:
    - path: "src/claude/responder.py"
      provides: "SignalResponder formats output for Signal"
      min_lines: 60
      exports: ["SignalResponder"]
    - path: "tests/test_claude_responder.py"
      provides: "Tests for Signal message formatting"
      contains: "test_format_tool_call"
  key_links:
    - from: "SignalResponder.format()"
      to: "ParsedOutput"
      via: "type-based formatting"
      pattern: "isinstance.*ToolCall"
---

<objective>
Format Claude output for mobile-friendly Signal display

Purpose: Convert parsed Claude events into readable Signal messages optimized for mobile
Output: SignalResponder that formats tool calls, progress, errors for Signal
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Previous plans in this phase
@.planning/phases/03-claude-integration/03-01-SUMMARY.md
@.planning/phases/03-claude-integration/03-02-SUMMARY.md

# Parser output types
@src/claude/parser.py

# Signal messaging infrastructure
@src/signal/client.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SignalResponder with mobile-optimized formatting (TDD RED-GREEN-REFACTOR)</name>
  <files>tests/test_claude_responder.py, src/claude/responder.py</files>
  <action>
**RED**: Write failing tests:
- test_format_tool_call(): ToolCall("Read", "file.py") ‚Üí "üìñ Read: file.py"
- test_format_progress(): Progress("Analyzing") ‚Üí "‚è≥ Analyzing..."
- test_format_error(): Error("Failed") ‚Üí "‚ùå Error: Failed"
- test_format_response(): Response("Hello") ‚Üí "Hello"
- test_split_long_message(): 2000-char response ‚Üí list of <1600 char chunks
- test_preserve_code_blocks(): Response with ``` blocks ‚Üí chunks preserve blocks

**GREEN**: Implement SignalResponder:
- format(parsed: ParsedOutput) -> str:
  - ToolCall ‚Üí Emoji + tool name + target (üìñ Read, ‚úèÔ∏è Edit, üíæ Write, üîß Bash)
  - Progress ‚Üí ‚è≥ + message
  - Error ‚Üí ‚ùå + message
  - Response ‚Üí text as-is
- split_for_signal(text: str, max_len=1600) -> List[str]:
  - Split on sentence boundaries if possible
  - Preserve code blocks (don't split ```...```)
  - Add continuation markers ("...continued")

Signal message limit: 1600 chars (mobile safe). Use emojis for visual scanning on mobile.

**REFACTOR**: Extract emoji constants if repetitive.

**TDD Strategy**: Write test ‚Üí run (fails) ‚Üí implement ‚Üí run (passes) ‚Üí refactor ‚Üí commit each phase
  </action>
  <verify>pytest tests/test_claude_responder.py -v passes</verify>
  <done>SignalResponder formats events with emojis, splits long messages, preserves code blocks</done>
</task>

<task type="auto">
  <name>Task 2: Add rate-aware message batching</name>
  <files>src/claude/responder.py</files>
  <action>
Add MessageBatcher (standard implementation - simple state management):
- __init__(min_batch_interval: float = 0.5): Minimum time between message sends
- add(message: str): Buffer message
- should_flush() -> bool: True if buffer has messages AND min interval passed
- flush() -> List[str]: Return buffered messages, reset timer

Prevents flooding Signal with rapid tool call updates. Batch updates every 0.5s for smooth mobile display.
  </action>
  <verify>pytest tests/test_claude_responder.py passes (add test for batching)</verify>
  <done>MessageBatcher batches rapid updates to prevent Signal flooding</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_claude_responder.py -v passes
- [ ] git log shows TDD commits for formatting logic
- [ ] All ParsedOutput types formatted correctly
- [ ] Long messages split properly
- [ ] Code blocks preserved across splits
</verification>

<success_criteria>

- All tests pass
- TDD commits for formatting logic
- SignalResponder formats tool calls, progress, errors with emojis
- Long messages split at 1600 chars preserving structure
- MessageBatcher prevents Signal flooding
</success_criteria>

<output>
After completion, create `.planning/phases/03-claude-integration/03-03-SUMMARY.md`
</output>
