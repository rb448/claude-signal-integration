---
phase: 03-claude-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/claude/bridge.py, tests/test_claude_bridge.py]
autonomous: true

must_haves:
  truths:
    - "Signal message 'help me debug this' reaches Claude Code CLI"
    - "Claude Code CLI receives message in proper format"
    - "Communication channel remains open for response"
  artifacts:
    - path: "src/claude/bridge.py"
      provides: "CLIBridge class with send_command() method"
      min_lines: 50
      exports: ["CLIBridge"]
    - path: "tests/test_claude_bridge.py"
      provides: "Tests for command sending"
      contains: "test_send_command"
  key_links:
    - from: "CLIBridge.send_command()"
      to: "claude-code CLI stdin"
      via: "process.stdin.write()"
      pattern: "stdin\\.write"
---

<objective>
Establish bidirectional communication with Claude Code CLI subprocess

Purpose: Enable command input from Signal to reach Claude Code and responses to flow back
Output: CLIBridge that sends commands and receives responses from claude-code process
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 2 context - subprocess management exists
@.planning/phases/02-session-management-durable-execution/02-03-SUMMARY.md
@.planning/phases/02-session-management-durable-execution/02-05-SUMMARY.md

# Existing subprocess code
@src/claude/process.py
@src/session/commands.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CLIBridge with stdin/stdout communication (TDD RED-GREEN-REFACTOR)</name>
  <files>tests/test_claude_bridge.py, src/claude/bridge.py</files>
  <action>
**RED**: Write failing tests for CLIBridge:
- test_send_command(): Verify command written to stdin with newline
- test_read_response(): Verify response read from stdout line by line
- test_is_connected(): Verify connection status check

**GREEN**: Implement CLIBridge:
- __init__(process: asyncio.subprocess.Process): Store process reference
- async send_command(command: str): Write command to stdin with newline flush
- async read_response(): Read from stdout until complete (yield lines)
- is_connected property: Check process.returncode is None

Use asyncio streams for async I/O. Commands end with \n. Read stdout line-by-line with asyncio.StreamReader.readline().

**REFACTOR**: Clean up if obvious improvements exist.

**TDD Strategy**: Write test → run (fails) → implement → run (passes) → refactor → commit each phase
  </action>
  <verify>pytest tests/test_claude_bridge.py -v passes all tests</verify>
  <done>CLIBridge sends commands to stdin, reads responses from stdout, detects connection status</done>
</task>

<task type="auto">
  <name>Task 2: Integrate CLIBridge with ClaudeProcess</name>
  <files>src/claude/process.py</files>
  <action>
Add CLIBridge to ClaudeProcess:
- Import CLIBridge from src.claude.bridge
- In start(): After spawning process, create self._bridge = CLIBridge(self._process)
- Add get_bridge() method: Returns self._bridge or raises if not started
- Update type hints to show _bridge: Optional[CLIBridge]

NO behavior changes - ClaudeProcess still just starts/stops subprocess. CLIBridge is now available for Phase 3 command routing.
  </action>
  <verify>python -m pytest tests/test_claude_process.py -v passes (existing tests still work)</verify>
  <done>ClaudeProcess exposes CLIBridge via get_bridge() after start()</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_claude_bridge.py -v passes
- [ ] pytest tests/test_claude_process.py -v passes
- [ ] git log shows test commits before feat commits (TDD discipline)
- [ ] CLIBridge can send/receive from mock subprocess
</verification>

<success_criteria>

- All tests pass
- TDD commits: test(03-01) → feat(03-01) → optional refactor(03-01)
- CLIBridge integrated into ClaudeProcess
- No breaking changes to existing session management
</success_criteria>

<output>
After completion, create `.planning/phases/03-claude-integration/03-01-SUMMARY.md`
</output>
