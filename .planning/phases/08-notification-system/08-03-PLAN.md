---
phase: 08-notification-system
plan: 03
type: execute
wave: 2
depends_on: ["08-02"]
files_modified:
  - src/notification/commands.py
  - tests/test_notification_commands.py
  - src/session/commands.py
  - tests/test_session_commands.py
autonomous: true

must_haves:
  truths:
    - "User can view current notification preferences via /notify list"
    - "User can enable notifications for event type via /notify enable <type>"
    - "User can disable notifications for event type via /notify disable <type>"
    - "User sees help text for /notify commands"
  artifacts:
    - path: "src/notification/commands.py"
      provides: "NotificationCommands handler for /notify commands"
      exports: ["NotificationCommands"]
      min_lines: 60
    - path: "tests/test_notification_commands.py"
      provides: "Tests for notification command routing"
      contains: "test.*notify"
  key_links:
    - from: "NotificationCommands.handle()"
      to: "NotificationPreferences"
      via: "CRUD operations for user preferences"
      pattern: "await.*preferences\\.(get|set)_preference"
    - from: "SessionCommands.handle()"
      to: "NotificationCommands"
      via: "Priority routing after approval commands"
      pattern: "if.*notification_commands"
---

<objective>
Implement /notify command interface for viewing and modifying notification preferences from Signal.

Purpose: Enable users to configure notifications directly from mobile without editing config files
Output: NotificationCommands component with routing integration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-notification-system/08-02-SUMMARY.md

Command patterns to follow (from Phase 2, 4, 5):
@src/session/commands.py - SessionCommands routing pattern
@src/thread/commands.py - ThreadCommands handler pattern
@src/approval/commands.py - ApprovalCommands pattern

Command handler requirements:
- handle(message, thread_id) → str | None
- Return None for unknown commands (fallthrough)
- Return string response for recognized commands
- help() → formatted help text
- Mobile-friendly output (truncate IDs, clear formatting)

Routing priority (from Phase 5):
1. ApprovalCommands (most urgent)
2. NotificationCommands (user configuration)
3. ThreadCommands (project management)
4. SessionCommands (session lifecycle)
5. Claude orchestrator (everything else)

</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NotificationCommands handler</name>
  <files>src/notification/commands.py, tests/test_notification_commands.py</files>
  <action>
    Implement NotificationCommands following Phase 5 ApprovalCommands pattern:

    Commands:
    - "/notify list" → show current preferences for this thread
    - "/notify enable <event_type>" → enable notifications for event type
    - "/notify disable <event_type>" → disable notifications for event type
    - "/notify help" → show command reference

    Implementation:
    - __init__(self, preferences: NotificationPreferences)
    - async handle(message: str, thread_id: str) → str | None
    - _format_preferences(prefs: dict) → str (mobile-friendly table)
    - help() → str (command reference)

    Output format for /notify list:
    ```
    Notification Preferences

    ✅ error (urgent)
    ✅ approval_needed (urgent)
    ✅ completion (important)
    ❌ progress (info)
    ✅ reconnection (important)

    Use /notify enable/disable <type>
    ```

    Response format for enable/disable:
    ```
    ✅ Enabled notifications for <event_type>
    ❌ Disabled notifications for <event_type>
    ⚠️ Cannot disable urgent events (error, approval_needed)
    ```

    Edge cases:
    - Unknown event_type → "Unknown event type: <type>. Use /notify list to see options."
    - Attempt to disable URGENT → "Cannot disable urgent notifications"
    - Attempt to enable SILENT → "Cannot enable silent notifications"

    Tests to write:
    - test_notify_list_shows_current_preferences
    - test_notify_enable_updates_preference
    - test_notify_disable_updates_preference
    - test_notify_help_returns_help_text
    - test_notify_unknown_command_returns_none
    - test_notify_cannot_disable_urgent
    - test_notify_unknown_event_type_error
  </action>
  <verify>pytest tests/test_notification_commands.py passes</verify>
  <done>NotificationCommands handles all /notify commands with mobile-friendly output</done>
</task>

<task type="auto">
  <name>Task 2: Wire NotificationCommands into SessionCommands</name>
  <files>src/session/commands.py, tests/test_session_commands.py</files>
  <action>
    Integrate NotificationCommands into SessionCommands routing hierarchy following Phase 5 ApprovalCommands pattern:

    Changes to SessionCommands:
    1. Add notification_commands: NotificationCommands | None parameter to __init__
    2. Update handle() priority routing:
       ```python
       async def handle(self, message: str, thread_id: str) -> str:
           # 1. Approval commands (most urgent)
           if self.approval_commands:
               if response := await self.approval_commands.handle(message, thread_id):
                   return response

           # 2. Notification commands (user configuration)
           if self.notification_commands:
               if response := await self.notification_commands.handle(message, thread_id):
                   return response

           # 3. Thread commands
           # ... existing thread and session logic
       ```
    3. Update help() to include notification commands when available

    Tests to add:
    - test_notification_commands_take_priority_over_thread_commands
    - test_notification_commands_fall_through_to_session
    - test_help_includes_notification_commands_when_available

    Follow Phase 5 pattern:
    - Optional parameter for backwards compatibility
    - Priority-based routing
    - Dynamic help text composition
  </action>
  <verify>pytest tests/test_session_commands.py passes with notification routing tests</verify>
  <done>NotificationCommands routed with correct priority in SessionCommands hierarchy</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_notification_commands.py passes
- [ ] pytest tests/test_session_commands.py passes (with new routing tests)
- [ ] All /notify commands work correctly
- [ ] Priority routing correct (approval → notify → thread → session)
- [ ] Help text includes notification commands
- [ ] Mobile-friendly output formatting
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Notification commands routed correctly
- User can view and modify preferences from Signal
</success_criteria>

<output>
After completion, create `.planning/phases/08-notification-system/08-03-SUMMARY.md`
</output>
