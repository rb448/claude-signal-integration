---
phase: 08-notification-system
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/notification/categorizer.py
  - src/notification/formatter.py
  - tests/test_notification_categorizer.py
  - tests/test_notification_formatter.py
autonomous: true

must_haves:
  truths:
    - "Error events categorized as URGENT urgency"
    - "Approval events categorized as URGENT urgency"
    - "Completion events categorized as IMPORTANT urgency"
    - "Progress events categorized as INFORMATIONAL urgency"
    - "Notification messages readable on mobile (clear, concise)"
  artifacts:
    - path: "src/notification/categorizer.py"
      provides: "Event categorization with urgency rules"
      exports: ["EventCategorizer", "UrgencyLevel"]
      min_lines: 40
    - path: "src/notification/formatter.py"
      provides: "Mobile-optimized notification message formatting"
      exports: ["NotificationFormatter"]
      min_lines: 30
    - path: "tests/test_notification_categorizer.py"
      provides: "TDD tests for categorization rules"
      contains: "test.*categorize"
    - path: "tests/test_notification_formatter.py"
      provides: "TDD tests for message formatting"
      contains: "test.*format"
  key_links:
    - from: "EventCategorizer"
      to: "UrgencyLevel enum"
      via: "categorize() returns UrgencyLevel"
      pattern: "def categorize.*->.*UrgencyLevel"
    - from: "NotificationFormatter"
      to: "Event object"
      via: "format() accepts event dict"
      pattern: "def format.*event.*->.*str"
---

<objective>
Implement core notification logic with event categorization and mobile-friendly message formatting.

Purpose: Foundation for notification system - categorize events by urgency and format messages for Signal delivery
Output: EventCategorizer and NotificationFormatter components with full TDD coverage
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Phase 8 builds on:
- Phase 5 approval system (provides approval_needed events)
- Phase 7 connection resilience (provides reconnection events)
- Phase 3 Claude orchestrator (provides error and completion events)

Event types to support:
- error (Claude errors, daemon failures) ‚Üí URGENT
- approval_needed (from Phase 5 ApprovalWorkflow) ‚Üí URGENT
- completion (session task done) ‚Üí IMPORTANT
- progress (tool calls, intermediate updates) ‚Üí INFORMATIONAL
- reconnection (connection state changes) ‚Üí IMPORTANT

Existing infrastructure:
- Signal send_message() for delivery
- Session context for persistence
- Command routing pattern from SessionCommands

</context>

<feature>
  <name>Event Categorization</name>
  <files>src/notification/categorizer.py, tests/test_notification_categorizer.py</files>
  <behavior>
    EventCategorizer.categorize(event) classifies events by urgency level:
    - error ‚Üí URGENT (always notify)
    - approval_needed ‚Üí URGENT (always notify)
    - completion ‚Üí IMPORTANT (notify unless disabled)
    - progress ‚Üí INFORMATIONAL (notify if enabled)
    - reconnection ‚Üí IMPORTANT (notify unless disabled)
    - unknown event types ‚Üí INFORMATIONAL (defensive default)

    Input: event dict with {"type": str, "details": dict}
    Output: UrgencyLevel enum (URGENT, IMPORTANT, INFORMATIONAL, SILENT)

    Edge cases:
    - Missing "type" field ‚Üí default to INFORMATIONAL
    - Empty event dict ‚Üí default to INFORMATIONAL
    - Case-insensitive type matching (ERROR vs error)
  </behavior>
  <implementation>
    TDD approach:
    RED: Write failing tests for each event type ‚Üí urgency mapping
    GREEN: Implement categorize() with simple dict lookup
    REFACTOR: Extract urgency rules to constant for configurability

    Implementation notes:
    - UrgencyLevel as Enum(URGENT=0, IMPORTANT=1, INFORMATIONAL=2, SILENT=3)
    - Category rules as class constant URGENCY_RULES: dict[str, UrgencyLevel]
    - Case-insensitive matching via event["type"].lower()
    - Defensive default: unknown types ‚Üí INFORMATIONAL
  </implementation>
</feature>

<feature>
  <name>Notification Formatting</name>
  <files>src/notification/formatter.py, tests/test_notification_formatter.py</files>
  <behavior>
    NotificationFormatter.format(event) creates mobile-friendly notification text:
    - Prefix with urgency emoji (üö® URGENT, ‚ö†Ô∏è IMPORTANT, ‚ÑπÔ∏è INFO)
    - Event type in bold (Signal markdown: *error*)
    - Concise summary from event details
    - Max 300 chars for mobile readability

    Input: event dict with {"type": str, "details": dict, "session_id": str (optional)}
    Output: formatted string ready for Signal send_message()

    Examples:
    - error event: "üö® *Error*: Claude failed to read config.json (FileNotFoundError)"
    - approval_needed: "üö® *Approval Needed*: Edit src/main.py (23 lines changed)"
    - completion: "‚ö†Ô∏è *Complete*: Session abc123de finished processing"
    - progress: "‚ÑπÔ∏è *Progress*: Reading src/utils.py (347 lines)"

    Edge cases:
    - Long details ‚Üí truncate with "..." at 280 chars (leave 20 for prefix)
    - Missing details ‚Üí use generic message
    - Session ID present ‚Üí include truncated ID (8 chars)
  </behavior>
  <implementation>
    TDD approach:
    RED: Write failing tests for each event type format
    GREEN: Implement format() with template strings
    REFACTOR: Extract emoji mappings and templates to constants

    Implementation notes:
    - Emoji mapping: URGENCY_EMOJI: dict[UrgencyLevel, str]
    - Template per event type: "{emoji} *{type}*: {summary}"
    - Truncation helper: _truncate(text, max_len) with "..." suffix
    - Session ID formatter: _format_session_id(session_id) ‚Üí first 8 chars
  </implementation>
</feature>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_notification_categorizer.py passes
- [ ] pytest tests/test_notification_formatter.py passes
- [ ] Test coverage >90% for both modules
- [ ] All event types have categorization tests
- [ ] All urgency levels have formatting tests
</verification>

<success_criteria>
- Failing test written and committed (RED phase)
- Implementation passes test (GREEN phase)
- Refactor complete if needed
- All 2-3 commits present (test ‚Üí feat ‚Üí optional refactor)
- Event categorization working for all defined types
- Notification formatting produces mobile-readable messages
</success_criteria>

<output>
After completion, create `.planning/phases/08-notification-system/08-01-SUMMARY.md` with:
- RED: Tests written for categorization and formatting, why they failed
- GREEN: Implementation that made tests pass
- REFACTOR: Cleanup performed (if any)
- Commits: List of TDD commits produced
</output>
