---
phase: 11
plan: 01
title: Fix execute_command wiring and response routing
created: 2026-01-28
---

# Plan 11-01: Fix execute_command wiring and response routing

**Goal:** Restore primary user flow by fixing parameter passing and response routing

**Gap Closure:** Fixes 2 critical integration gaps identified in v1.0 milestone audit:
- Gap 1: execute_command() signature mismatch - missing recipient and thread_id parameters
- Gap 2: Response routing broken - orchestrator uses session_id instead of thread_id

**Complexity:** LOW (2-3 line changes)

---

## Context

The milestone audit revealed that all 56 v1 requirements are satisfied individually, but the primary user flow is broken due to two wiring gaps:

1. **SessionCommands** calls `execute_command()` with only 2 of 4 required parameters (missing `recipient` and `thread_id`)
2. **ClaudeOrchestrator** routes responses using `session_id` (UUID) instead of `thread_id` (phone number)

These gaps prevent users from sending commands to Claude and receiving responses, making the system non-functional despite being 95% complete.

**Audit Evidence:**
- Location: `.planning/v1.0-MILESTONE-AUDIT.md`
- Integration score: 7/8 (one partial connection)
- Flow score: 4/5 (primary flow broken)
- Impact: CRITICAL (blocks deployment)

---

## TDD Strategy

Follow strict RED-GREEN-REFACTOR:

1. **RED:** Write failing integration test for full user flow
2. **GREEN:** Fix execute_command call (add missing parameters)
3. **GREEN:** Fix response routing (store and use thread_id)
4. **REFACTOR:** None needed (changes are minimal)

**Test-First Order:**
1. Write `test_full_user_flow_integration` → FAILS at execute_command call
2. Fix `src/session/commands.py` line 237 → TEST FAILS at response routing
3. Fix `src/claude/orchestrator.py` lines 67, 216 → TEST PASSES
4. Verify no regressions (run full test suite)

---

## Tasks

### Task 1: Write Integration Test for Full User Flow

**Test:** `tests/integration/test_full_user_flow.py`

**What to Test:**
- User starts session via `/session start /path/to/project`
- Session created successfully (state ACTIVE)
- User sends Claude command "Read the README"
- Command reaches ClaudeOrchestrator.execute_command() with all 4 parameters
- Response routes back using thread_id
- User receives response in Signal

**Expected Initial Result:** FAIL (signature mismatch at execute_command call)

**Code Structure:**
```python
import pytest
from src.daemon.service import SignalDaemon
from src.session.manager import SessionManager
from src.claude.orchestrator import ClaudeOrchestrator

@pytest.mark.asyncio
async def test_full_user_flow_integration():
    """Test complete flow: start session → send command → receive response"""

    # Setup: Mock Signal client, authorized phone
    authorized_phone = "+1234567890"
    thread_id = "+1234567890"  # Same as phone for 1:1 chat

    # Simulate: User sends /session start /tmp/test-project
    # Assert: Session created, state ACTIVE

    # Simulate: User sends "Read the README"
    # Assert: execute_command() receives 4 parameters:
    #   - command="Read the README"
    #   - session_id=<UUID>
    #   - recipient=thread_id
    #   - thread_id=thread_id

    # Assert: Response routed using thread_id (not session_id)
    # Assert: User receives response message
```

**Files:**
- Create: `tests/integration/test_full_user_flow.py`

**Success Criteria:**
- Test exists and runs
- Test fails with clear error: "execute_command() missing 2 required positional arguments: 'recipient' and 'thread_id'"

---

### Task 2: Fix execute_command Call in SessionCommands

**Location:** `src/session/commands.py` line 237

**Current (BROKEN):**
```python
await self.orchestrator.execute_command(message, session_id)
```

**Required Fix:**
```python
await self.orchestrator.execute_command(
    command=message,
    session_id=session_id,
    recipient=thread_id,
    thread_id=thread_id
)
```

**Why This Works:**
- `command`: The user's message to Claude
- `session_id`: Links response to correct session
- `recipient`: Phone number for attachments (code files)
- `thread_id`: Routing key for responses (replaces incorrect session_id usage)

**Test After Fix:**
- Run `test_full_user_flow_integration`
- Expected: FAIL at response routing (orchestrator still uses session_id)

**Files:**
- Edit: `src/session/commands.py` (1 line change at line 237)

**Success Criteria:**
- execute_command() call matches signature
- Test progresses past signature mismatch error
- Test fails at next step (response routing)

---

### Task 3: Fix Response Routing in ClaudeOrchestrator

**Location:** `src/claude/orchestrator.py` lines 67 and 216

**Problem:** Orchestrator stores `session_id` but needs `thread_id` for response routing

**Fix Part 1 (Line 67):** Store thread_id when execute_command called

**Current:**
```python
async def execute_command(
    self,
    command: str,
    session_id: str,
    recipient: str,
    thread_id: str | None = None
):
    """Execute Claude command and stream responses"""
    self.session_id = session_id
    # ...
```

**Add After Line 68:**
```python
    self.session_id = session_id
    self.current_thread_id = thread_id  # ADD THIS LINE
```

**Fix Part 2 (Line 216):** Use thread_id for routing instead of session_id

**Current (BROKEN):**
```python
await self.send_signal(self.session_id, message)
```

**Required Fix:**
```python
await self.send_signal(self.current_thread_id, message)
```

**Why This Works:**
- `send_signal` callback expects phone number (E.164 format)
- `thread_id` IS the phone number for 1:1 chats
- `session_id` is a UUID, not a valid phone number

**Test After Fix:**
- Run `test_full_user_flow_integration`
- Expected: PASS (full flow now works)

**Files:**
- Edit: `src/claude/orchestrator.py` (2 changes: lines 68, 216)

**Success Criteria:**
- Responses route using thread_id
- `test_full_user_flow_integration` passes
- No test regressions

---

### Task 4: Verify No Regressions

**Run Full Test Suite:**
```bash
pytest --cov=src --cov-report=term-missing
```

**Expected Results:**
- All 624+ existing tests still pass
- New integration test passes
- Coverage remains ≥89%
- No new skipped tests

**Check Integration Score:**
- Re-run milestone audit (after manual testing):
  ```
  /gsd:audit-milestone
  ```
- Expected: Integration score 8/8 (up from 7/8)
- Expected: Flow score 5/5 (up from 4/5)

**Manual Verification:**
1. Start daemon: `python -m src.daemon.service`
2. From Signal, send: `/session start /tmp/test-project`
3. From Signal, send: "Read the README"
4. Verify: Response received in Signal

**Files:**
- No new files
- Run existing test suite

**Success Criteria:**
- All tests pass (no regressions)
- Manual test confirms full flow works
- Integration gaps closed

---

## Dependencies

**Depends On:**
- Phase 3 (Claude Integration) - infrastructure already exists
- Phase 2 (Session Management) - SessionCommands already wired

**Blocks:**
- v1.0 deployment (cannot ship without primary user flow)

**No External Dependencies:** All required infrastructure exists

---

## Verification Criteria

After completing this plan:

- [ ] Integration test `test_full_user_flow_integration` exists and passes
- [ ] SessionCommands calls execute_command() with all 4 parameters
- [ ] ClaudeOrchestrator stores thread_id and uses it for routing
- [ ] Manual test: User can send Claude command and receive response
- [ ] All 624+ existing tests still pass (no regressions)
- [ ] Coverage ≥89% maintained
- [ ] Milestone audit integration score: 8/8 (up from 7/8)
- [ ] Milestone audit flow score: 5/5 (up from 4/5)
- [ ] Primary user flow works end-to-end

**Expected Outcome:**
- Status: DEPLOYMENT READY
- Integration: 100% (8/8)
- Flows: 100% (5/5)
- User can fully control Claude from Signal

---

## Notes

**Why These Gaps Existed:**

From audit analysis:
- Phase 3 verification focused on individual component functionality
- Components worked in isolation (tests mocked dependencies)
- End-to-end wiring wasn't tested until milestone audit
- Parameters existed in signature but weren't passed from caller

**Root Cause:** Missing integration test for full user flow

**Prevention:** Task 1 adds the missing integration test to catch similar gaps

**Risk:** LOW - Both fixes are simple parameter passing, no architectural changes

**Estimated Time:** 30-60 minutes (test + 2 fixes + verification)

---

_Created: 2026-01-28_
_Phase: 11 (Gap Closure)_
_Complexity: LOW_
