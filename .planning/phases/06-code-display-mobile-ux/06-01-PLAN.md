---
phase: 06-code-display-mobile-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/claude/code_formatter.py
  - tests/test_code_formatter.py
autonomous: true

must_haves:
  truths:
    - "Short code snippets (<20 lines) display inline with monospace formatting"
    - "Long code (>100 lines) triggers file attachment mode"
    - "Code width fits within 320px mobile constraint"
  artifacts:
    - path: "src/claude/code_formatter.py"
      provides: "Mobile-optimized code formatting with length detection"
      min_lines: 80
      exports: ["CodeFormatter"]
    - path: "tests/test_code_formatter.py"
      provides: "Test coverage for formatter logic"
      min_lines: 100
  key_links:
    - from: "CodeFormatter"
      to: "SignalResponder"
      via: "format() method integration"
      pattern: "CodeFormatter.*format"
---

<objective>
Create mobile-optimized code formatter with length-based inline/attachment decision logic.

Purpose: Enable readable code display on 320px mobile screens with automatic attachment for long files.
Output: CodeFormatter class with format(), should_attach(), and width constraint handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work relevant to this plan
@.planning/phases/03-claude-integration/03-03-SUMMARY.md

# Existing code to extend
@src/claude/responder.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CodeFormatter with length detection (TDD)</name>
  <files>src/claude/code_formatter.py, tests/test_code_formatter.py</files>
  <action>
    **RED Phase:**
    Write failing tests in tests/test_code_formatter.py:
    - test_format_short_code_inline() - Code < 20 lines returns inline format
    - test_format_long_code_attachment_signal() - Code > 100 lines signals attachment needed
    - test_line_counting() - Verify accurate line counting (handles \n, \r\n)
    - test_mobile_width_constraint() - Lines wrap at 320px equivalent (~80 chars in monospace)
    - test_should_attach_thresholds() - < 20 lines = False, > 100 lines = True, 20-100 = False (default inline)

    Run pytest - tests must fail (no implementation yet).

    Commit: `test(06-01): add failing tests for code formatter`

    **GREEN Phase:**
    Implement src/claude/code_formatter.py:
    - CodeFormatter class with format(code: str, language: str = "text") -> str method
    - should_attach(code: str) -> bool method checking line count thresholds
    - Line wrapping at 80 chars (320px รท 4px per char in typical mobile monospace)
    - Return formatted string with triple-backtick fencing for inline code
    - ATTACHMENT_THRESHOLD = 100 lines, INLINE_THRESHOLD = 20 lines constants

    Run pytest - all tests must pass.

    Commit: `feat(06-01): implement CodeFormatter with length detection`

    **REFACTOR Phase (if needed):**
    - Extract constants (thresholds, width limits)
    - Clean up formatting logic if complex

    Only commit if changes made: `refactor(06-01): extract code formatter constants`
  </action>
  <verify>pytest tests/test_code_formatter.py -v shows all tests passing</verify>
  <done>CodeFormatter formats short code inline, detects when attachment needed, respects 80-char mobile width</done>
</task>

<task type="auto">
  <name>Task 2: Integrate CodeFormatter into SignalResponder</name>
  <files>src/claude/responder.py, tests/test_claude_responder.py</files>
  <action>
    Extend SignalResponder in src/claude/responder.py:
    - Import CodeFormatter
    - Add _code_formatter = CodeFormatter() instance variable
    - Modify format() method to detect code blocks in Response output
    - For code blocks: call formatter.format() for inline or add ATTACHMENT marker
    - Pattern: "```language\n...\n```" detection in response text

    Add tests in tests/test_claude_responder.py:
    - test_format_response_with_short_code() - Inline code preserved
    - test_format_response_with_long_code() - ATTACHMENT marker added
    - test_format_response_mixed_content() - Text + code handled correctly

    Run full test suite: pytest tests/test_claude_responder.py tests/test_code_formatter.py -v

    Commit: `feat(06-01): integrate CodeFormatter into SignalResponder`
  </action>
  <verify>pytest shows all responder and formatter tests passing</verify>
  <done>SignalResponder uses CodeFormatter for code blocks, marks long code for attachment</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_code_formatter.py -v passes
- [ ] pytest tests/test_claude_responder.py -v passes
- [ ] Code < 20 lines displays inline
- [ ] Code > 100 lines marked for attachment
- [ ] Line wrapping at 80 chars works
</verification>

<success_criteria>
- All tasks completed
- All tests passing (formatter + responder)
- TDD cycle followed (test commits before feat commits)
- No new errors or warnings
- CODE-01 and CODE-02 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/06-code-display-mobile-ux/06-01-SUMMARY.md`
</output>
