---
phase: 06-code-display-mobile-ux
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/claude/diff_renderer.py
  - tests/test_diff_renderer.py
autonomous: true

must_haves:
  truths:
    - "Git diffs render in readable format on mobile"
    - "Side-by-side or overlay mode available"
    - "Diff output fits within 320px constraint"
  artifacts:
    - path: "src/claude/diff_renderer.py"
      provides: "Mobile-optimized diff rendering"
      min_lines: 100
      exports: ["DiffRenderer", "DiffMode"]
    - path: "tests/test_diff_renderer.py"
      provides: "Test coverage for diff rendering"
      min_lines: 120
  key_links:
    - from: "DiffRenderer"
      to: "CodeFormatter"
      via: "Uses format() for code sections"
      pattern: "CodeFormatter.*format"
---

<objective>
Create mobile-friendly diff renderer with overlay mode for 320px screens.

Purpose: Display code changes readably on mobile without horizontal scrolling.
Output: DiffRenderer class with parse(), render(), and mode selection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 6 dependencies
@.planning/phases/06-code-display-mobile-ux/06-01-SUMMARY.md

# Existing formatter to reuse
@src/claude/code_formatter.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DiffRenderer with overlay mode (TDD)</name>
  <files>src/claude/diff_renderer.py, tests/test_diff_renderer.py</files>
  <action>
    **RED Phase:**
    Write failing tests in tests/test_diff_renderer.py:
    - test_parse_unified_diff() - Parse git diff output into structured format
    - test_render_overlay_mode() - Render diff as overlay (- removed, + added, space unchanged)
    - test_render_side_by_side_mode() - Render diff with before|after columns (40 chars each)
    - test_mobile_width_constraint_overlay() - Overlay mode fits 80 chars
    - test_mobile_width_constraint_sidebyside() - Side-by-side uses 40|40 split
    - test_empty_diff() - No changes returns "No changes"
    - test_large_diff_summary() - > 50 lines shows summary instead of full diff

    Run pytest - tests must fail.

    Commit: `test(06-03): add failing tests for diff renderer`

    **GREEN Phase:**
    Implement src/claude/diff_renderer.py:
    - DiffMode enum: OVERLAY, SIDE_BY_SIDE
    - DiffRenderer class with:
      - parse(diff_text: str) -> DiffObject (file_path, hunks with line changes)
      - render(diff_obj: DiffObject, mode: DiffMode = DiffMode.OVERLAY) -> str
    - Overlay mode: "- old line" and "+ new line" with color codes (red/green)
    - Side-by-side: "old line | new line" with 40 char width each
    - Large diff (>50 lines): show summary "X files changed, Y insertions, Z deletions"

    Run pytest - all tests pass.

    Commit: `feat(06-03): implement DiffRenderer with overlay and side-by-side modes`

    **REFACTOR Phase:**
    - Extract width constants
    - Simplify rendering logic

    Only commit if changes made: `refactor(06-03): extract diff rendering constants`
  </action>
  <verify>pytest tests/test_diff_renderer.py -v shows all tests passing</verify>
  <done>DiffRenderer parses git diffs, renders overlay/side-by-side modes within 80-char constraint</done>
</task>

<task type="auto">
  <name>Task 2: Integrate DiffRenderer with CodeFormatter for syntax highlighting</name>
  <files>src/claude/diff_renderer.py, tests/test_diff_renderer.py</files>
  <action>
    Extend DiffRenderer to use CodeFormatter for syntax highlighting:
    - Import CodeFormatter
    - Add _formatter = CodeFormatter() instance
    - In render(), apply formatter.format() to code sections before diff coloring
    - Preserve diff markers (-, +) while highlighting code syntax

    Add tests:
    - test_render_with_syntax_highlighting() - Python diff has syntax colors + diff colors
    - test_highlight_before_diff_markers() - Syntax highlighting applied first, then diff markers
    - test_overlay_with_highlighting() - Overlay mode preserves both color schemes

    Run full test suite: pytest tests/test_diff_renderer.py -v

    Commit: `feat(06-03): add syntax highlighting to diff rendering`
  </action>
  <verify>pytest shows all diff renderer tests passing with syntax highlighting</verify>
  <done>DiffRenderer applies syntax highlighting to code sections while preserving diff markers</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_diff_renderer.py -v passes
- [ ] Overlay mode renders within 80 chars
- [ ] Side-by-side mode uses 40|40 split
- [ ] Large diffs show summary
- [ ] Syntax highlighting works in diffs
</verification>

<success_criteria>
- All tasks completed
- All tests passing
- TDD cycle followed
- CODE-04 requirement satisfied (diff rendering on mobile)
- Both overlay and side-by-side modes available
</success_criteria>

<output>
After completion, create `.planning/phases/06-code-display-mobile-ux/06-03-SUMMARY.md`
</output>
