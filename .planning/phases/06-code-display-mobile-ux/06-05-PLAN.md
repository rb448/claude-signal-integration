---
phase: 06-code-display-mobile-ux
plan: 05
type: execute
wave: 3
depends_on: ["06-01", "06-04"]
files_modified:
  - src/session/commands.py
  - tests/test_session_commands.py
autonomous: true

must_haves:
  truths:
    - "User can request full code view when summary insufficient"
    - "/code command shows full inline code"
    - "/code attach command sends as file attachment"
  artifacts:
    - path: "src/session/commands.py"
      provides: "/code command with view options"
      min_lines: 300
      contains: "handle_code"
    - path: "tests/test_session_commands.py"
      provides: "Test coverage for code commands"
      min_lines: 400
  key_links:
    - from: "/code command"
      to: "CodeFormatter"
      via: "format() call for full display"
      pattern: "code_formatter.*format"
---

<objective>
Add /code command for user-requested full code view.

Purpose: Enable users to request full code display when summaries insufficient.
Output: /code command with inline/attach options integrated into SessionCommands.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 6 dependencies
@.planning/phases/06-code-display-mobile-ux/06-01-SUMMARY.md
@.planning/phases/06-code-display-mobile-ux/06-04-SUMMARY.md

# Existing commands to extend
@src/session/commands.py

# Formatter to use
@src/claude/code_formatter.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add /code command to SessionCommands (TDD)</name>
  <files>src/session/commands.py, tests/test_session_commands.py</files>
  <action>
    **RED Phase:**
    Write failing tests in tests/test_session_commands.py:
    - test_code_command_show_inline() - /code shows last code inline
    - test_code_command_attach() - /code attach signals attachment needed
    - test_code_command_no_recent_code() - /code with no recent code returns error
    - test_code_command_with_file_path() - /code src/file.py shows specific file
    - test_code_help() - /code help shows usage

    Run pytest - tests must fail.

    Commit: `test(06-05): add failing tests for /code command`

    **GREEN Phase:**
    Extend SessionCommands in src/session/commands.py:
    - Add _code_formatter = CodeFormatter() instance
    - Add _last_code_response: Optional[str] = None to track recent code
    - Add handle_code(args: List[str]) -> str method:
      - /code → show last code inline (formatted)
      - /code attach → signal attachment needed for last code
      - /code <filepath> → read and show file (if path valid)
      - /code help → show usage
    - Route "/code" in handle() method
    - Update help text to include /code command

    Run pytest - all tests pass.

    Commit: `feat(06-05): implement /code command with inline and attach options`

    **REFACTOR Phase:**
    - Extract code retrieval logic if complex

    Only commit if changes made: `refactor(06-05): simplify code command logic`
  </action>
  <verify>pytest tests/test_session_commands.py::test_code_* -v shows all tests passing</verify>
  <done>/code command routes correctly, shows inline/attach modes, handles errors</done>
</task>

<task type="auto">
  <name>Task 2: Track code responses in ClaudeOrchestrator for /code access</name>
  <files>src/claude/orchestrator.py, tests/test_claude_orchestrator.py</files>
  <action>
    Extend ClaudeOrchestrator to track code for /code command:
    - Add _last_code_response: Optional[str] = None instance variable
    - In handle_command(), detect Response with code blocks
    - Extract code from response and store in _last_code_response
    - Add get_last_code() -> Optional[str] method for SessionCommands

    Add tests in tests/test_claude_orchestrator.py:
    - test_tracks_code_responses() - Code from Response stored
    - test_get_last_code() - get_last_code() returns tracked code
    - test_no_code_returns_none() - Non-code responses don't update tracker

    Run pytest tests/test_claude_orchestrator.py -v

    Commit: `feat(06-05): track code responses in orchestrator for /code command`
  </action>
  <verify>pytest shows orchestrator tests passing with code tracking</verify>
  <done>ClaudeOrchestrator tracks code responses, SessionCommands can access via get_last_code()</done>
</task>

<task type="auto">
  <name>Task 3: Wire orchestrator code tracking to SessionCommands</name>
  <files>src/session/commands.py, tests/test_session_commands.py</files>
  <action>
    Connect SessionCommands to orchestrator's code tracking:
    - Add orchestrator: Optional[ClaudeOrchestrator] parameter to __init__
    - In handle_code(), call orchestrator.get_last_code() if available
    - Fall back to error if orchestrator not wired or no code available

    Add test:
    - test_code_command_uses_orchestrator_tracking() - /code retrieves from orchestrator.get_last_code()

    Run pytest tests/test_session_commands.py -v

    Commit: `feat(06-05): wire orchestrator code tracking to /code command`
  </action>
  <verify>pytest shows /code command working with orchestrator integration</verify>
  <done>/code command retrieves code from orchestrator, displays formatted output</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_session_commands.py -v passes
- [ ] pytest tests/test_claude_orchestrator.py -v passes
- [ ] /code shows last code inline
- [ ] /code attach signals attachment mode
- [ ] /code help shows usage
- [ ] Integration with orchestrator works
</verification>

<success_criteria>
- All tasks completed
- All tests passing
- TDD cycle followed
- CODE-06 requirement satisfied (user can request full code view)
- /code command documented in help text
</success_criteria>

<output>
After completion, create `.planning/phases/06-code-display-mobile-ux/06-05-SUMMARY.md`
</output>
