---
phase: 10-testing-quality
plan: 04
type: execute
wave: 2
depends_on: ["10-01", "10-02"]
files_modified:
  - .github/workflows/test.yml
  - .github/workflows/coverage.yml
  - pytest.ini
  - .coveragerc
autonomous: true

must_haves:
  truths:
    - "Tests run automatically on every pull request"
    - "Coverage report generated and displayed in PR comments"
    - "CI fails if coverage drops below 80%"
    - "Test failures block PR merges"
  artifacts:
    - path: ".github/workflows/test.yml"
      provides: "GitHub Actions test workflow"
      min_lines: 40
      contains: "pytest"
    - path: ".github/workflows/coverage.yml"
      provides: "Coverage reporting workflow"
      min_lines: 30
      contains: "pytest-cov"
    - path: "pytest.ini"
      provides: "pytest configuration"
      min_lines: 10
      contains: "testpaths"
    - path: ".coveragerc"
      provides: "Coverage tool configuration"
      min_lines: 15
      contains: "omit"
  key_links:
    - from: ".github/workflows/test.yml"
      to: "pytest"
      via: "GitHub Actions run step"
      pattern: "run: pytest"
    - from: ".github/workflows/coverage.yml"
      to: "pytest-cov"
      via: "coverage report generation"
      pattern: "pytest --cov"
---

<objective>
Set up automated CI/CD pipeline with test execution and coverage reporting.

Purpose: Ensure tests run automatically on every change, providing fast feedback and preventing regressions. Coverage tracking maintains quality bar.

Output: GitHub Actions workflows for automated testing and coverage reporting on pull requests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

# Phase 10 requirements this plan addresses:
# - TEST-07: Tests run automatically in CI/CD pipeline before merges
# - TEST-01: All core components have unit tests with >80% coverage (enforced by CI)

# Existing test infrastructure:
@pytest.ini
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions test workflow</name>
  <files>.github/workflows/test.yml</files>
  <action>
    Create automated test workflow:
    1. Create directory: `mkdir -p .github/workflows`
    2. Create test.yml with:
       - Trigger: on pull_request and push to main
       - Python setup: Python 3.11 (project requirement)
       - Dependencies: Install from requirements.txt or pyproject.toml
       - Cache: pip cache for faster runs
       - Test execution:
         ```yaml
         - name: Run tests
           run: |
             pytest -v --tb=short
         ```
       - Test matrix (optional): Test on Python 3.11 and 3.12
       - Failure handling: Fail workflow if any test fails
       - Artifact upload: Upload test results XML for debugging

    Workflow should:
    - Run on every PR and main branch push
    - Use ubuntu-latest runner
    - Install signal-cli-rest-api Docker dependencies if needed (or mock)
    - Complete in <5 minutes for fast feedback
  </action>
  <verify>
    - `.github/workflows/test.yml` syntax valid (check with `actionlint` if available)
    - Workflow triggers specified for pull_request and push events
    - Python version matches project requirement (3.11+)
  </verify>
  <done>GitHub Actions test workflow created and ready to run on PRs</done>
</task>

<task type="auto">
  <name>Task 2: Create coverage reporting workflow</name>
  <files>.github/workflows/coverage.yml, .coveragerc</files>
  <action>
    Create coverage workflow and configuration:
    1. Create coverage.yml workflow:
       - Trigger: on pull_request
       - Run pytest with coverage: `pytest --cov=src --cov-report=term --cov-report=xml`
       - Generate coverage badge
       - Comment on PR with coverage report (use codecov or coveralls action)
       - Fail if coverage < 80% threshold
       - Example action: `codecov/codecov-action@v3` or custom script

    2. Create/update .coveragerc:
       ```ini
       [run]
       source = src
       omit =
           */tests/*
           */__init__.py
           */conftest.py

       [report]
       exclude_lines =
           pragma: no cover
           def __repr__
           raise AssertionError
           raise NotImplementedError
           if __name__ == .__main__.:
       precision = 2

       [html]
       directory = htmlcov
       ```

    3. Update pytest.ini if needed:
       - Add coverage options: `--cov-report=term-missing`
  </action>
  <verify>
    - `.github/workflows/coverage.yml` exists
    - `.coveragerc` configures coverage tool correctly
    - Coverage threshold enforced (fail if <80%)
  </verify>
  <done>Coverage reporting workflow created with 80% enforcement</done>
</task>

<task type="auto">
  <name>Task 3: Configure pytest for CI environment</name>
  <files>pytest.ini</files>
  <action>
    Update pytest configuration for optimal CI execution:
    1. Update pytest.ini:
       ```ini
       [pytest]
       asyncio_mode = auto
       testpaths = tests
       pythonpath = .
       addopts =
           -v
           --tb=short
           --strict-markers
           --disable-warnings
           --color=yes
       markers =
           slow: marks tests as slow (deselect with '-m "not slow"')
           integration: marks tests as integration tests
           load: marks tests as load tests
           chaos: marks tests as chaos tests
       ```

    2. Add CI-specific optimizations:
       - `--maxfail=1` for fast failure (optional)
       - `--timeout=300` to prevent hanging tests (requires pytest-timeout)
       - Parallel execution with pytest-xdist: `-n auto` (optional)

    3. Document test markers in tests/README.md:
       - Unit tests: default, fast
       - Integration tests: `@pytest.mark.integration`
       - Load tests: `@pytest.mark.load`
       - Chaos tests: `@pytest.mark.chaos`

    CI can run different suites: `pytest -m "not slow"` for fast feedback.
  </action>
  <verify>
    - `pytest --collect-only` shows all tests with correct markers
    - pytest.ini has CI-friendly options
    - Test markers documented
  </verify>
  <done>pytest configured for efficient CI execution</done>
</task>

<task type="auto">
  <name>Task 4: Add PR status checks and documentation</name>
  <files>.github/workflows/test.yml, .github/workflows/coverage.yml, README.md</files>
  <action>
    Finalize CI/CD setup and document:
    1. Add workflow status badges to README.md:
       ```markdown
       ![Tests](https://github.com/USER/REPO/workflows/Tests/badge.svg)
       ![Coverage](https://img.shields.io/codecov/c/github/USER/REPO)
       ```

    2. Document testing workflow in README.md:
       - How to run tests locally: `pytest -v`
       - How to run with coverage: `pytest --cov=src --cov-report=term-missing`
       - How to run specific test suites: `pytest -m integration`
       - CI requirements: All tests must pass, coverage >= 80%

    3. Configure GitHub branch protection (manual step - document):
       - Require test workflow to pass before merge
       - Require coverage workflow to pass before merge
       - Require 1 approval for PRs (optional)

    4. Add .github/PULL_REQUEST_TEMPLATE.md:
       - Checklist: Tests added, tests pass locally, coverage maintained

    Document the setup so future contributors understand the testing requirements.
  </action>
  <verify>
    - README.md contains testing documentation
    - Workflow badges display correctly (once workflows run)
    - PR template exists with testing checklist
  </verify>
  <done>CI/CD fully documented and ready for use</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `.github/workflows/test.yml` exists and is valid YAML
- [ ] `.github/workflows/coverage.yml` exists and is valid YAML
- [ ] pytest.ini configured for CI execution
- [ ] README.md documents testing workflow
- [ ] Workflows will trigger on PR creation (verify after commit)
</verification>

<success_criteria>
- All tasks completed
- GitHub Actions workflows created for tests and coverage
- pytest configured for efficient CI execution
- Coverage threshold enforced at 80%
- Testing workflow fully documented
- Foundation for continuous quality assurance established
</success_criteria>

<output>
After completion, create `.planning/phases/10-testing-quality/10-04-SUMMARY.md`
</output>
