---
phase: 04-multi-project
plan: 04
type: execute
wave: 4
depends_on: ["04-01", "04-02", "04-03"]
files_modified: [src/session/commands.py, tests/test_session_commands.py, tests/test_session_integration.py]
autonomous: true

must_haves:
  truths:
    - "/session start validates thread has project mapping"
    - "/session start uses mapped project path automatically"
    - "User gets helpful error if thread not mapped"
    - "Sessions created in mapped project directories"
  artifacts:
    - path: "src/session/commands.py"
      provides: "Project validation via thread mappings"
      contains: "thread_mapper.get_by_thread"
    - path: "tests/test_session_integration.py"
      provides: "End-to-end tests with thread mapping validation"
      min_lines: 40
  key_links:
    - from: "SessionCommands._start()"
      to: "ThreadMapper.get_by_thread()"
      via: "Lookup mapping before creating session"
      pattern: "await.*thread_mapper\\.get_by_thread"
    - from: "SessionCommands._start()"
      to: "SessionManager.create()"
      via: "Uses mapped project_path"
      pattern: "await self\\.manager\\.create\\(mapping\\.project_path"
---

<objective>
Integrate thread mappings into session creation workflow for automatic project selection.

Purpose: Make sessions respect thread-project mappings - when user starts a session in a mapped thread, automatically use that project directory without requiring explicit path specification.

Output: Session creation validates thread mappings and uses mapped paths, with helpful errors for unmapped threads.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work
@.planning/phases/04-multi-project/04-01-SUMMARY.md
@.planning/phases/04-multi-project/04-02-SUMMARY.md
@.planning/phases/04-multi-project/04-03-SUMMARY.md
@.planning/phases/02-session-management-durable-execution/02-05-SUMMARY.md

# Existing architecture
@src/session/commands.py
@src/thread/mapper.py

## Key Context from Plans 04-01, 04-02, 04-03, and Phase 2-5

**What exists:**
- ThreadMapper: get_by_thread(thread_id) returns ThreadMapping or None (Plan 04-01)
- ThreadCommands: /thread map/list/unmap work (Plan 04-02)
- Integration: ThreadMapper and ThreadCommands wired into daemon (Plan 04-03)
- SessionCommands._start(): Current implementation (Phase 2-5)

**Current _start() logic (Phase 2-5):**
```python
async def _start(self, thread_id: str, project_path: str | None) -> str:
    # Validate project_path
    if not project_path:
        return "Usage: /session start <project_path>"

    path = Path(project_path)
    if not path.exists() or not path.is_dir():
        return f"Error: Directory not found: {project_path}"

    # Create session
    session = await self.manager.create(project_path, thread_id)
    # ... start process, store in thread_sessions ...
```

**New logic needed:**
1. Check thread_mapper.get_by_thread(thread_id)
2. If mapping exists:
   - Use mapping.project_path (ignore user-provided path if any)
   - User doesn't need to specify path
3. If no mapping and no path provided:
   - Return helpful error: "Thread not mapped. Use '/thread map <path>' or '/session start <path>'"
4. If no mapping but path provided:
   - Use provided path (current behavior)
   - Optionally suggest mapping: "Tip: Use '/thread map <path>' to avoid specifying path each time"

**User experience improvement:**
Before Phase 4:
```
User: /session start /Users/me/project1
Bot: ✓ Session abc123de started in /Users/me/project1
```

After Phase 4:
```
User: /thread map /Users/me/project1
Bot: ✓ Thread abc123de mapped to /Users/me/project1

User: /session start
Bot: ✓ Session def456ab started in /Users/me/project1
```

**StateDecision to track:**
"Use mapped project_path when available, fall back to explicit path for backward compatibility"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SessionCommands to accept ThreadMapper</name>
  <files>src/session/commands.py, src/daemon/service.py</files>
  <action>
    Modify SessionCommands.__init__() to accept thread_mapper:
    ```python
    def __init__(
        self,
        manager: SessionManager,
        lifecycle: SessionLifecycle,
        process_factory: Callable[..., ClaudeProcess],
        orchestrator: ClaudeOrchestrator | None = None,
        thread_commands: ThreadCommands | None = None,
        thread_mapper: ThreadMapper | None = None  # NEW
    ):
        self.manager = manager
        self.lifecycle = lifecycle
        self.process_factory = process_factory
        self.orchestrator = orchestrator
        self.thread_commands = thread_commands
        self.thread_mapper = thread_mapper  # NEW
        self.processes: dict[str, ClaudeProcess] = {}
        self.thread_sessions: dict[str, str] = {}
    ```

    Update daemon (src/daemon/service.py) to pass thread_mapper:
    ```python
    self.commands = SessionCommands(
        self.manager,
        lifecycle,
        lambda project_path, session_id: ClaudeProcess(project_path, session_id),
        orchestrator=self.orchestrator,
        thread_commands=self.thread_commands,
        thread_mapper=self.thread_mapper  # NEW
    )
    ```

    Follow Plan 04-03 pattern: Optional parameter with None default.
  </action>
  <verify>
    - SessionCommands accepts thread_mapper parameter
    - Daemon passes thread_mapper when creating SessionCommands
  </verify>
  <done>SessionCommands has access to ThreadMapper</done>
</task>

<task type="auto">
  <name>Task 2: Update _start() to use thread mappings</name>
  <files>src/session/commands.py, tests/test_session_commands.py</files>
  <action>
    Modify SessionCommands._start() to check thread mappings:
    ```python
    async def _start(self, thread_id: str, project_path: str | None) -> str:
        # Try to get thread mapping first
        resolved_path: str | None = None

        if self.thread_mapper:
            mapping = await self.thread_mapper.get_by_thread(thread_id)
            if mapping:
                resolved_path = mapping.project_path
                # Ignore user-provided path if thread is mapped
            elif not project_path:
                # No mapping, no path provided
                return (
                    "Error: Thread not mapped to a project.\n"
                    "Use '/thread map <path>' or '/session start <path>'"
                )

        # Fall back to explicit path if no mapping
        if not resolved_path:
            resolved_path = project_path

        if not resolved_path:
            return "Usage: /session start <project_path>"

        # Validate path exists
        path = Path(resolved_path)
        if not path.exists() or not path.is_dir():
            return f"Error: Directory not found: {resolved_path}"

        # Create session (rest unchanged)
        session = await self.manager.create(resolved_path, thread_id)
        # ... existing process start logic ...
    ```

    Add tests in tests/test_session_commands.py:
    - test_start_uses_thread_mapping() - mapped thread uses mapping, ignores explicit path
    - test_start_unmapped_thread_requires_path() - unmapped thread needs explicit path
    - test_start_unmapped_thread_with_path_works() - backward compatibility
    - test_start_without_thread_mapper() - graceful degradation if mapper not provided

    Follow Phase 2-5 validation patterns:
    - Path.exists() and Path.is_dir() checks
    - Clear error messages
    - Backward compatibility (works without thread_mapper)
  </action>
  <verify>
    Run: pytest tests/test_session_commands.py -k start
    Result: All start tests pass including new thread mapping tests
  </verify>
  <done>Session creation respects thread mappings</done>
</task>

<task type="auto">
  <name>Task 3: Add end-to-end integration tests</name>
  <files>tests/test_session_integration.py</files>
  <action>
    Add integration tests for thread mapping + session workflow:
    ```python
    async def test_mapped_thread_session_workflow():
        """
        End-to-end: map thread → start session → session uses mapped path
        """
        # Setup: Create ThreadMapper, ThreadCommands, SessionCommands
        # 1. Map thread to project path
        # 2. Start session without explicit path
        # 3. Verify session.project_path == mapped path
        # 4. Verify session starts successfully

    async def test_unmapped_thread_explicit_path():
        """
        End-to-end: unmapped thread + explicit path works (backward compat)
        """
        # Setup: Create SessionCommands (no thread mapping)
        # 1. Start session with explicit path
        # 2. Verify session.project_path == explicit path
        # 3. Verify session starts successfully

    async def test_unmapped_thread_no_path_fails():
        """
        End-to-end: unmapped thread without path returns error
        """
        # Setup: Create SessionCommands with thread mapper
        # 1. Try to start session without path on unmapped thread
        # 2. Verify error message mentions '/thread map' or '/session start <path>'
    ```

    Follow existing test_session_integration.py patterns:
    - Use fixtures for database setup
    - Mock ClaudeProcess
    - Test full command strings ("/session start", "/thread map /path")
    - Verify responses contain expected success/error messages
  </action>
  <verify>
    Run: pytest tests/test_session_integration.py
    Result: All integration tests pass
  </verify>
  <done>End-to-end integration tests confirm thread mapping workflow</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] SessionCommands accepts and uses thread_mapper
- [ ] _start() checks thread mappings before creating sessions
- [ ] Mapped threads use mapped project paths automatically
- [ ] Unmapped threads require explicit path or return error
- [ ] Backward compatibility maintained (works without thread_mapper)
- [ ] All unit and integration tests pass
- [ ] No new test failures introduced
</verification>

<success_criteria>
- All tasks completed
- Thread mapping validation integrated into session workflow
- User experience improved: no need to specify path every time
- Clear error messages guide users to map threads
- Backward compatibility preserved
- Full test coverage for mapping integration
</success_criteria>

<output>
After completion, create `.planning/phases/04-multi-project/04-04-SUMMARY.md`
</output>
