---
phase: 04-multi-project
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified: [src/thread/commands.py, tests/test_thread_commands.py]
autonomous: true

must_haves:
  truths:
    - "User can create thread mapping with /thread map <path>"
    - "User can list all thread mappings with /thread list"
    - "User can unmap thread with /thread unmap"
    - "User gets helpful error messages for invalid operations"
  artifacts:
    - path: "src/thread/commands.py"
      provides: "ThreadCommands handling /thread subcommands"
      min_lines: 80
      exports: ["ThreadCommands"]
    - path: "tests/test_thread_commands.py"
      provides: "Test coverage for thread command routing"
      min_lines: 60
  key_links:
    - from: "ThreadCommands"
      to: "ThreadMapper"
      via: "ThreadCommands.mapper instance"
      pattern: "self\\.mapper\\.(map|get_by_thread|list_all|unmap)"
    - from: "/thread map <path>"
      to: "ThreadMapper.map()"
      via: "command parsing and delegation"
      pattern: "await self\\.mapper\\.map\\("
---

<objective>
Create user-facing commands for managing Signal thread to project directory mappings.

Purpose: Give users explicit control over which threads work on which projects via `/thread` commands accessible from Signal.

Output: ThreadCommands class handling `/thread map/list/unmap` subcommands with user-friendly responses.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work
@.planning/phases/04-multi-project/04-01-SUMMARY.md
@.planning/phases/02-session-management-durable-execution/02-05-SUMMARY.md

# Existing architecture
@src/session/commands.py
@src/thread/mapper.py

## Key Context from Plan 04-01 and Phase 2-5

**What exists:**
- ThreadMapper: Persistent storage for thread → project mappings (Plan 04-01)
- ThreadMapping dataclass, ThreadMappingError exception
- SessionCommands pattern: Command routing with /session subcommands (Phase 2-5)

**Pattern to follow:**
Phase 2-5 SessionCommands established:
- Command class with handle() method
- Subcommand parsing (split on whitespace)
- User-friendly error messages
- Integration with daemon via handle() calls
- TDD with mocking for dependencies

**Command format (matching /session):**
```
/thread map /path/to/project
/thread list
/thread unmap
/thread help
```

**User experience:**
- Clear success messages with truncated IDs
- Helpful error messages (path doesn't exist, thread already mapped, etc.)
- List shows thread_id (truncated 8 chars), project path, created timestamp
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD - Write failing tests for ThreadCommands</name>
  <files>tests/test_thread_commands.py</files>
  <action>
    RED phase: Write failing tests for ThreadCommands class that doesn't exist yet.

    Test cases:
    1. test_thread_map_creates_mapping() - "/thread map /path/to/project" succeeds
    2. test_thread_map_rejects_nonexistent_path() - returns error message for invalid path
    3. test_thread_map_rejects_duplicate_thread() - returns error if thread already mapped
    4. test_thread_list_shows_mappings() - "/thread list" returns formatted list
    5. test_thread_list_empty() - returns "No thread mappings" when none exist
    6. test_thread_unmap_removes_mapping() - "/thread unmap" removes current thread's mapping
    7. test_thread_help_shows_usage() - "/thread help" returns command documentation
    8. test_thread_invalid_subcommand() - returns error for unknown subcommand

    Follow Phase 2-5 pattern:
    - pytest with pytest-asyncio
    - Mock ThreadMapper in fixtures
    - Async test functions
    - Test both success and error paths
    - Verify user-facing message formatting

    Tests MUST fail because ThreadCommands doesn't exist yet.
  </action>
  <verify>
    Run: pytest tests/test_thread_commands.py
    Result: All tests fail with "ThreadCommands not found" or import errors
  </verify>
  <done>Comprehensive failing test suite for thread commands</done>
</task>

<task type="auto">
  <name>Task 2: TDD - Implement ThreadCommands to pass tests</name>
  <files>src/thread/commands.py, src/thread/__init__.py</files>
  <action>
    GREEN phase: Implement ThreadCommands class to make tests pass.

    Class structure:
    ```python
    class ThreadCommands:
        def __init__(self, mapper: ThreadMapper):
            self.mapper = mapper

        async def handle(self, thread_id: str, message: str) -> str:
            # Parse subcommand from message
            # Route to: _map(), _list(), _unmap(), _help()
            # Return user-friendly response string

        async def _map(self, thread_id: str, project_path: str) -> str:
            # Validate path exists
            # Call mapper.map(thread_id, project_path)
            # Handle ThreadMappingError with user-friendly messages
            # Return success: "✓ Thread abc123de mapped to /path/to/project"

        async def _list(self) -> str:
            # Call mapper.list_all()
            # Format as table:
            # Thread    | Project Path         | Created
            # abc123de  | /path/to/project     | 2026-01-26 10:30
            # Return "No thread mappings." if empty

        async def _unmap(self, thread_id: str) -> str:
            # Call mapper.unmap(thread_id)
            # Return success: "✓ Thread abc123de unmapped"

        async def _help(self) -> str:
            # Return usage documentation matching /session help format
    ```

    Follow Phase 2-5 SessionCommands pattern:
    - handle() method for routing
    - Private methods for subcommands (_map, _list, etc.)
    - Truncate thread_ids to 8 chars in output (mobile-friendly)
    - User-friendly error messages with context
    - Help text showing all available commands

    Error handling:
    - Path doesn't exist: "Error: Path /foo/bar not found"
    - Thread already mapped: "Error: This thread is already mapped to /existing/path. Use '/thread unmap' first."
    - Path already mapped: "Error: Path /foo/bar is already mapped to thread xyz789ab"

    Success messages match Phase 2-5 style:
    - Checkmark prefix (✓)
    - Truncated IDs (8 chars)
    - Clear action description
  </action>
  <verify>
    Run: pytest tests/test_thread_commands.py
    Result: All tests pass
  </verify>
  <done>ThreadCommands implemented with full command routing</done>
</task>

<task type="auto">
  <name>Task 3: Export ThreadCommands from package</name>
  <files>src/thread/__init__.py</files>
  <action>
    Update src/thread/__init__.py to export ThreadCommands:
    ```python
    from .mapper import ThreadMapper, ThreadMapping, ThreadMappingError
    from .commands import ThreadCommands

    __all__ = [
        "ThreadMapper",
        "ThreadMapping",
        "ThreadMappingError",
        "ThreadCommands"
    ]
    ```

    Verify import works from external modules.
  </action>
  <verify>
    Run: python -c "from src.thread import ThreadCommands; print('Import successful')"
    Result: "Import successful"
  </verify>
  <done>ThreadCommands exported and importable</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All TDD tests pass (pytest tests/test_thread_commands.py)
- [ ] ThreadCommands class exists with handle() method
- [ ] All subcommands implemented (_map, _list, _unmap, _help)
- [ ] User-friendly error messages for all failure cases
- [ ] Success messages match Phase 2-5 formatting conventions
- [ ] ThreadCommands properly exported from src/thread/__init__.py
</verification>

<success_criteria>
- All tasks completed
- Full TDD test suite passing
- ThreadCommands ready for daemon integration in Plan 03
- Command interface matches /session command patterns
- No new test failures introduced
</success_criteria>

<output>
After completion, create `.planning/phases/04-multi-project/04-02-SUMMARY.md`
</output>
