---
phase: 14
plan: 01
title: Final Edge Case Coverage (80-89% → 95%)
created: 2026-01-29
---

# Plan 14-01: Final Edge Case Coverage for 4 Remaining Modules

**Goal:** Improve 4 modules from 80-89% to 95%+ coverage for comprehensive quality

**Current Coverage:**
- notification/formatter.py: 87% → Target: 95%
- signal/queue.py: 88% → Target: 95%
- claude/responder.py: 89% → Target: 95%
- claude/diff_processor.py: 90% → Target: 95%

**Context:** Phases 12-13 addressed all critical gaps (<80%) and one edge case module (auto_committer 82%→100%). Phase 14 is an optional quality enhancement to push all remaining 80-89% modules to excellence tier (95%+).

---

## TDD Strategy

Follow strict RED-GREEN-REFACTOR for all new tests:

1. **RED:** Run coverage report to identify uncovered lines
2. **GREEN:** Write unit test for uncovered error path
3. **REFACTOR:** Verify test passes against existing implementation

**Test-First Order:**
1. Run coverage report per module to identify specific uncovered lines
2. Write unit tests for uncovered error paths and edge cases
3. Verify tests pass (code already implements error handling)
4. Run coverage report to confirm 95%+ achievement per module

---

## Tasks

### Task 1: Improve notification/formatter.py Coverage (87% → 95%)

**Current Gap:** ~8% (estimated 2-3 tests needed)

**Run Coverage Report:**
```bash
pytest tests/test_notification_formatter.py \
  --cov=src/notification/formatter \
  --cov-report=term-missing
```

**Expected Uncovered Areas:**
- Edge cases in formatting logic (empty strings, None values)
- Error message formatting variations
- Truncation logic for long messages
- Emoji/unicode handling edge cases

**New Tests (Estimated 2-3):**

1. **test_format_notification_with_empty_message**
   - Scenario: Message content is empty string or None
   - Verify: Graceful handling, no crashes
   - Target: Error handling path

2. **test_format_notification_with_unicode_overflow**
   - Scenario: Message contains emojis/unicode causing length edge cases
   - Verify: Proper truncation respecting unicode boundaries
   - Target: Unicode handling path

3. **test_format_error_notification_variations**
   - Scenario: Different error types (OSError, ValueError, etc.)
   - Verify: Appropriate error message formatting per type
   - Target: Error type branching logic

**Files:**
- Edit: `tests/test_notification_formatter.py` (add 2-3 tests)

**Success Criteria:**
- notification/formatter.py coverage ≥95%
- All new tests pass
- No regressions

**Estimated Time:** 15 minutes

---

### Task 2: Improve signal/queue.py Coverage (88% → 95%)

**Current Gap:** ~7% (estimated 2 tests needed)

**Run Coverage Report:**
```bash
pytest tests/test_signal_client.py \
  --cov=src/signal/queue \
  --cov-report=term-missing
```

**Expected Uncovered Areas:**
- Queue overflow scenarios (max size exceeded)
- Concurrent enqueue/dequeue edge cases
- Empty queue handling

**New Tests (Estimated 2):**

1. **test_queue_max_size_overflow**
   - Scenario: Enqueue beyond max capacity
   - Verify: Oldest items dropped or error raised per policy
   - Target: Queue size limit enforcement

2. **test_queue_concurrent_drain_race**
   - Scenario: Multiple coroutines drain simultaneously
   - Verify: Thread-safe behavior, no duplicate processing
   - Target: Concurrency edge case

**Files:**
- Edit: `tests/test_signal_client.py` (add 2 tests in queue section)

**Success Criteria:**
- signal/queue.py coverage ≥95%
- All new tests pass
- No regressions

**Estimated Time:** 10 minutes

---

### Task 3: Improve claude/responder.py Coverage (89% → 95%)

**Current Gap:** ~6% (estimated 3 tests needed)

**Run Coverage Report:**
```bash
pytest tests/test_claude_responder.py \
  --cov=src/claude/responder \
  --cov-report=term-missing
```

**Expected Uncovered Areas:**
- Response formatting edge cases (None, empty, malformed)
- Error response construction
- Message chunking for long responses

**New Tests (Estimated 3):**

1. **test_format_response_with_none_content**
   - Scenario: Claude returns None or empty response
   - Verify: Graceful handling, user receives appropriate message
   - Target: None/empty content path

2. **test_format_error_response**
   - Scenario: Error needs to be formatted for user
   - Verify: User-friendly error message construction
   - Target: Error formatting path

3. **test_chunk_long_response_boundary_cases**
   - Scenario: Response exactly at chunk boundary or Unicode split
   - Verify: Proper chunking without breaking characters
   - Target: Chunking edge cases

**Files:**
- Edit: `tests/test_claude_responder.py` (add 3 tests)

**Success Criteria:**
- claude/responder.py coverage ≥95%
- All new tests pass
- No regressions

**Estimated Time:** 20 minutes

---

### Task 4: Improve claude/diff_processor.py Coverage (90% → 95%)

**Current Gap:** ~5% (estimated 2 tests needed)

**Run Coverage Report:**
```bash
pytest tests/test_diff_processor.py \
  --cov=src/claude/diff_processor \
  --cov-report=term-missing
```

**Expected Uncovered Areas:**
- Malformed diff handling
- Edge cases in diff parsing (empty lines, special characters)
- Error recovery during diff processing

**New Tests (Estimated 2):**

1. **test_process_malformed_diff**
   - Scenario: Diff format is invalid or corrupted
   - Verify: Error logged, graceful degradation
   - Target: Malformed input handling

2. **test_diff_with_unicode_and_special_chars**
   - Scenario: Diff contains Unicode, tabs, CRLF variations
   - Verify: Proper parsing and formatting
   - Target: Character encoding edge cases

**Files:**
- Edit: `tests/test_diff_processor.py` (add 2 tests)

**Success Criteria:**
- claude/diff_processor.py coverage ≥95%
- All new tests pass
- No regressions

**Estimated Time:** 15 minutes

---

### Task 5: Verify Coverage Improvements

**Run Full Coverage Report:**

```bash
pytest --cov=src --cov-report=term-missing --cov-report=html
```

**Validate Improvements:**
- notification/formatter.py: ≥95% (from 87%)
- signal/queue.py: ≥95% (from 88%)
- claude/responder.py: ≥95% (from 89%)
- claude/diff_processor.py: ≥95% (from 90%)
- Overall: ≥93% (from 91-92%)

**Generate Summary:**

Count modules by coverage tier:
```bash
# 100% coverage modules
grep "100%" htmlcov/index.html | wc -l

# 95-99% coverage modules
grep -E "9[5-9]%" htmlcov/index.html | wc -l

# 90-94% coverage modules
grep -E "9[0-4]%" htmlcov/index.html | wc -l
```

**Commit Coverage Report:**

```bash
git add tests/
git commit -m "test(14-01): final edge case coverage - 4 modules from 80-89% to 95%

Coverage improvements:
- notification/formatter.py: 87% → 95%
- signal/queue.py: 88% → 95%
- claude/responder.py: 89% → 95%
- claude/diff_processor.py: 90% → 95%
- Overall: 91-92% → 93%+

Added 9-10 unit tests covering:
- Empty/None content handling
- Unicode and character encoding edge cases
- Queue overflow and concurrency
- Error formatting and malformed input
- Message chunking boundaries

All tests pass, no regressions.

Generated with [Claude Code](https://claude.ai/code)
via [Happy](https://happy.engineering)

Co-Authored-By: Claude <noreply@anthropic.com>
Co-Authored-By: Happy <yesreply@happy.engineering>"
```

**Files:**
- Read: Coverage reports (HTML and terminal output)
- Verify: All 4 modules ≥95%
- Verify: Overall coverage ≥93%

**Success Criteria:**
- All 4 target modules ≥95% coverage
- 9-10 new tests passing
- Coverage report committed
- No test failures

**Estimated Time:** 10 minutes (verification and commit)

---

## Dependencies

**Depends On:**
- Phase 10 (Testing & Quality) - test infrastructure exists
- Phase 12 (Test Coverage Improvement) - pattern established
- Phase 13 (Edge Case Coverage) - auto_committer pattern proven

**Blocks:**
- None (optional quality enhancement, not functional requirement)

**External Dependencies:**
- pytest-cov (already installed)
- Coverage.py (already configured)

---

## Verification Criteria

After completing this plan:

- [ ] notification/formatter.py coverage ≥95% (from 87%)
- [ ] signal/queue.py coverage ≥95% (from 88%)
- [ ] claude/responder.py coverage ≥95% (from 89%)
- [ ] claude/diff_processor.py coverage ≥95% (from 90%)
- [ ] Overall project coverage ≥93% (from 91-92%)
- [ ] 9-10 new unit tests added (2-3 per module)
- [ ] All existing tests still pass (no regressions)
- [ ] All new tests pass
- [ ] Coverage report committed to repository
- [ ] HTML coverage report generated for analysis

**Expected Outcome:**
- **ALL** modules now at 95%+ or 85%+ tier
- Zero modules below 80% threshold
- Industry-leading overall coverage (93%+)
- Comprehensive edge case validation
- Production-ready quality metrics for v1.0 deployment

---

## Notes

**Why This Phase:**

- Completes the quality improvement journey started in Phases 12-13
- Pushes all "good" (80-89%) modules to "excellent" (95%+) tier
- Estimated 60 minutes total effort (distributed across 4 modules)
- Optional but achieves comprehensive coverage across entire codebase

**What We're Testing:**

- Edge cases: empty/None values, Unicode, boundaries
- Error paths: malformed input, exceptions
- Concurrency: race conditions, thread safety
- NOT testing happy paths (already well-covered at 80-90%)

**95% Target Rationale:**

- 80-89% represents "good" coverage
- 95% represents "excellent" coverage
- Brings all modules to excellence tier
- Aligns with Phase 13 quality standards (auto_committer achieved 100%)

**Post-Phase 14 Status:**

If executed, the project will have:
- 17+ modules at 100% coverage
- 20+ modules at 95-99% coverage
- 15+ modules at 90-94% coverage
- 0 modules below 85% (far above 80% minimum)
- Overall coverage: 93-94% (industry-leading)

**Estimated Time:** 60 minutes (15+10+20+15+10)

---

_Created: 2026-01-29_
_Phase: 14 (Final Edge Case Coverage)_
_Priority: Optional Quality Enhancement (Excellence Tier)_
