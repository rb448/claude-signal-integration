---
phase: 05-permissions
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/approval/manager.py
  - src/approval/models.py
  - tests/test_approval_manager.py
autonomous: true

must_haves:
  truths:
    - "Approval request transitions through pending → approved/rejected/timeout states"
    - "Timeout triggers after 10 minutes of inactivity"
    - "Approved operations can execute, rejected operations skip"
  artifacts:
    - path: "src/approval/manager.py"
      provides: "Approval state machine and lifecycle"
      exports: ["ApprovalManager", "ApprovalRequest"]
    - path: "src/approval/models.py"
      provides: "Approval state definitions"
      exports: ["ApprovalState"]
    - path: "tests/test_approval_manager.py"
      provides: "TDD test suite for state machine"
      min_lines: 80
  key_links:
    - from: "ApprovalManager.request()"
      to: "ApprovalRequest object"
      via: "Creates pending approval"
      pattern: "ApprovalRequest\\(.*state=ApprovalState\\.PENDING"
    - from: "ApprovalManager.check_timeout()"
      to: "ApprovalRequest.state"
      via: "Transitions pending → timeout after 10min"
      pattern: "state\\s*=\\s*ApprovalState\\.TIMEOUT"
---

<objective>
Implement TDD-driven approval state machine managing operation approval lifecycle.

Purpose: Track approval requests from creation through approval/rejection/timeout
Output: ApprovalManager with comprehensive state transition tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 2 context - state machine patterns
@.planning/phases/02-session-management/02-02-SUMMARY.md
@src/session/lifecycle.py
</context>

<feature>
  <name>Approval State Machine</name>
  <files>src/approval/manager.py, src/approval/models.py, tests/test_approval_manager.py</files>
  <behavior>
**State transitions (from ROADMAP TDD Strategy):**

```
PENDING → APPROVED  (user approves)
PENDING → REJECTED  (user rejects)
PENDING → TIMEOUT   (10 minutes elapse)
```

**Expected behavior:**
```python
# Create approval request
request = manager.request(tool_call, reason="Edit modifies file")
assert request.state == ApprovalState.PENDING

# User approves
manager.approve(request.id)
assert request.state == ApprovalState.APPROVED

# Timeout detection
manager.request(tool_call2)
await asyncio.sleep(601)  # 10 min + 1 sec
manager.check_timeouts()
assert request2.state == ApprovalState.TIMEOUT
```

**Edge cases:**
- Approving already-approved request (idempotent)
- Rejecting timed-out request (state preserved)
- Multiple pending requests tracked independently
- Approval ID collision handling
  </behavior>
  <implementation>
**After tests written and failing:**

1. Create ApprovalState enum (PENDING, APPROVED, REJECTED, TIMEOUT)
2. Create ApprovalRequest dataclass with state, timestamp, tool_call, reason
3. Implement ApprovalManager with:
   - request() → creates pending approval
   - approve(id) → transitions to APPROVED
   - reject(id) → transitions to REJECTED
   - check_timeouts() → scans for 10min+ pending, marks TIMEOUT
4. Track pending approvals in dict[str, ApprovalRequest]
5. Use datetime for timeout calculation (UTC-aware)
  </implementation>
</feature>

<verification>
- [ ] pytest tests/test_approval_manager.py passes
- [ ] All state transitions tested
- [ ] Timeout logic verified (10 minute threshold)
- [ ] Edge cases covered
- [ ] RED-GREEN-REFACTOR cycle followed
</verification>

<success_criteria>
- Failing tests written and committed (RED)
- Implementation passes all tests (GREEN)
- Code refactored if needed (REFACTOR)
- All 2-3 commits present
- State machine follows PENDING → APPROVED/REJECTED/TIMEOUT
- Timeout triggers at 10 minutes
- Multiple concurrent requests supported
</success_criteria>

<output>
After completion, create `.planning/phases/05-permissions/05-02-SUMMARY.md`

Include RED-GREEN-REFACTOR phases and commit history
</output>
