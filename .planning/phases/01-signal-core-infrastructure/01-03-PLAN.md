---
phase: 01-signal-core-infrastructure
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/daemon/service.py
  - src/daemon/__init__.py
  - src/auth/phone_verifier.py
  - com.user.signal-claude-bot.plist
  - config/daemon.json
  - tests/test_auth.py
autonomous: true

must_haves:
  truths:
    - Daemon starts automatically via launchd on macOS login
    - Daemon restarts automatically after crash within 10 seconds
    - Only authorized phone number can send commands to bot
    - Health check endpoint returns daemon status
    - Unauthorized messages logged and ignored
  artifacts:
    - path: com.user.signal-claude-bot.plist
      provides: launchd service configuration
      contains: "KeepAlive"
      min_lines: 15
    - path: src/daemon/service.py
      provides: Main daemon service
      exports: [ServiceDaemon]
      min_lines: 60
    - path: src/auth/phone_verifier.py
      provides: Phone number authentication
      exports: [PhoneVerifier]
      min_lines: 25
  key_links:
    - from: com.user.signal-claude-bot.plist
      to: src/daemon/service.py
      via: launchd ProgramArguments
      pattern: "python.*service\\.py"
    - from: src/daemon/service.py
      to: src/auth/phone_verifier.py
      via: message authentication
      pattern: "PhoneVerifier.*verify"
    - from: src/auth/phone_verifier.py
      to: config/daemon.json
      via: authorized number lookup
      pattern: "authorized_number"
---

<objective>
Establish daemon lifecycle management with launchd and phone number authentication for secure bot access.

Purpose: Enable always-available bot service that auto-restarts on crash and only responds to authorized user's phone number.
Output: Production daemon with auto-restart and authentication protecting against unauthorized access.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning-signal/SIGNAL-PROJECT.md
@.planning-signal/SIGNAL-ROADMAP.md
@.planning-signal/research/SIGNAL-STACK.md - launchd patterns for macOS
@.planning-signal/research/SIGNAL-ARCHITECTURE.md - Daemon component responsibilities
@.planning-signal/SIGNAL-REQUIREMENTS.md - INFRA-03, INFRA-05 requirements
@.planning-signal/phases/01-signal-core-infrastructure/01-02-SUMMARY.md - Message queue and rate limiter
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create daemon service with health checks</name>
  <files>src/daemon/service.py, src/daemon/__init__.py</files>
  <action>
    Create src/daemon/service.py with ServiceDaemon class:
    - Implements main daemon loop using asyncio.run()
    - Initializes SignalClient from Plan 01 and MessageQueue from Plan 02
    - Runs HTTP health check endpoint on port 8081 (GET /health returns {"status":"ok"})
    - Handles graceful shutdown on SIGTERM/SIGINT
    - Logs startup/shutdown events with structlog

    Create src/daemon/__init__.py with daemon module exports.

    Use aiohttp for health check HTTP server. Follow research/ARCHITECTURE.md daemon patterns.
  </action>
  <verify>python src/daemon/service.py starts without errors, curl http://localhost:8081/health returns 200</verify>
  <done>ServiceDaemon runs with health check endpoint and graceful shutdown</done>
</task>

<task type="auto">
  <name>Task 2: Implement phone number authentication</name>
  <files>src/auth/phone_verifier.py, config/daemon.json</files>
  <action>
    Create src/auth/phone_verifier.py with PhoneVerifier class:
    - verify(phone_number: str) -> bool method checks if number authorized
    - Loads authorized number from config/daemon.json
    - Returns True only if phone_number matches authorized_number
    - Logs authentication attempts (success at INFO, failures at WARN)

    Create config/daemon.json with:
    - authorized_number field (placeholder: "+1234567890")
    - log_level field (default: "INFO")
    - Other daemon config as needed

    Use E.164 format for phone numbers (+CountryCodeNumber). Exact match only - no partial matching.
  </action>
  <verify>python -c "from src.auth.phone_verifier import PhoneVerifier; v = PhoneVerifier(); print(v.verify('+1234567890'))" returns True for authorized number</verify>
  <done>PhoneVerifier authenticates messages against configured authorized number</done>
</task>

<task type="auto">
  <name>Task 3: Integrate authentication into daemon message processing</name>
  <files>src/daemon/service.py</files>
  <action>
    Update ServiceDaemon from Task 1:
    - Add PhoneVerifier instance
    - Wrap message processing loop to check sender phone number
    - Ignore messages from unauthorized numbers (log at WARN level with sender number)
    - Only process messages from authorized number through MessageQueue

    DO NOT break existing health check or shutdown logic from Task 1.
  </action>
  <verify>python src/daemon/service.py starts and logs "Ignoring message from unauthorized number" when test message sent from wrong number</verify>
  <done>Daemon only processes messages from authorized phone number</done>
</task>

<task type="auto">
  <name>Task 4: Create launchd service configuration with auto-restart</name>
  <files>com.user.signal-claude-bot.plist</files>
  <action>
    Create com.user.signal-claude-bot.plist for launchd:
    - Label: com.user.signal-claude-bot
    - ProgramArguments: ["/usr/bin/python3", "/path/to/src/daemon/service.py"]
    - RunAtLoad: true (start on login)
    - KeepAlive: true (auto-restart on crash)
    - StandardOutPath: ~/Library/Logs/signal-claude-bot/stdout.log
    - StandardErrorPath: ~/Library/Logs/signal-claude-bot/stderr.log
    - WorkingDirectory: /path/to/project/root

    Use absolute paths for Python and service.py. Follow research/STACK.md launchd patterns.
    DO NOT use Supervisor or PM2 - launchd is native macOS solution.
  </action>
  <verify>plutil -lint com.user.signal-claude-bot.plist shows "OK", file is valid XML plist format</verify>
  <done>launchd plist configured for auto-start and auto-restart</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Daemon service with launchd auto-restart and phone authentication</what-built>
  <how-to-verify>
    1. Load launchd service: cp com.user.signal-claude-bot.plist ~/Library/LaunchAgents/ && launchctl load ~/Library/LaunchAgents/com.user.signal-claude-bot.plist
    2. Verify running: launchctl list | grep signal-claude-bot shows status 0
    3. Check health: curl http://localhost:8081/health returns {"status":"ok"}
    4. Test crash recovery: kill -9 $(pgrep -f "daemon/service.py") && sleep 11 && curl http://localhost:8081/health
    5. Verify logs: tail -f ~/Library/Logs/signal-claude-bot/stdout.log shows daemon restart messages
    6. Send test Signal message from authorized number: verify bot logs "Processing message from authorized number"
    7. Send test Signal message from unauthorized number: verify bot logs "Ignoring message from unauthorized number"
  </how-to-verify>
  <resume-signal>Type "approved" if all 7 verification steps pass, or describe issues</resume-signal>
</task>

<task type="auto">
  <name>Task 5: Add authentication tests</name>
  <files>tests/test_auth.py</files>
  <action>
    Create tests/test_auth.py:
    - Test authorized number: verify('+1234567890') returns True when configured
    - Test unauthorized number: verify('+9999999999') returns False
    - Test empty number: verify('') returns False
    - Test invalid format: verify('not-a-phone') returns False

    Use pytest. Test against mock config to avoid hardcoded phone numbers.
  </action>
  <verify>pytest tests/test_auth.py -v shows all tests passing</verify>
  <done>Authentication logic validated with unit tests</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] launchctl list shows signal-claude-bot loaded and running
- [ ] Health check responds: curl http://localhost:8081/health returns 200
- [ ] Crash recovery works: daemon restarts within 10 seconds of kill -9
- [ ] Authentication works: only authorized number's messages processed
- [ ] All tests pass: pytest tests/ shows 100% pass rate
</verification>

<success_criteria>
- ServiceDaemon runs with health check endpoint and graceful shutdown
- PhoneVerifier authenticates messages against authorized phone number
- launchd configuration enables auto-start and auto-restart
- Daemon ignores messages from unauthorized numbers
- All unit tests passing
- Phase 1 complete: Signal infrastructure operational
- Ready for Phase 2: Session Management & Durable Execution
</success_criteria>

<output>
After completion, create `.planning-signal/phases/01-signal-core-infrastructure/01-03-SUMMARY.md`
</output>
