---
phase: 06-code-display
plan: 04
type: execute
wave: 3
depends_on: ["06-01", "06-02", "06-03"]
files_modified: [src/claude/diff_renderer.py, tests/test_diff_renderer.py]
autonomous: false

must_haves:
  truths:
    - "Diffs render in readable format on 320px mobile screens"
    - "User can distinguish added vs removed vs context lines visually"
  artifacts:
    - path: "src/claude/diff_renderer.py"
      provides: "Mobile-optimized diff rendering with visual distinction"
      exports: ["DiffRenderer"]
      min_lines: 50
    - path: "tests/test_diff_renderer.py"
      provides: "Test coverage for diff rendering"
      min_lines: 40
  key_links:
    - from: "DiffRenderer.render()"
      to: "Formatted diff text"
      via: "overlay mode with color/emoji markers"
      pattern: "\\+.*green|\\-.*red|emoji"
    - from: "Rendered output"
      to: "320px width constraint"
      via: "CodeFormatter integration"
      pattern: "format_code|MAX_WIDTH"
---

<objective>
Render git diffs in mobile-friendly overlay format with visual distinction for added/removed lines.

Purpose: Make code changes understandable on small screens without side-by-side layout.

Output: DiffRenderer creates readable diff display optimized for 320px screens with human verification checkpoint.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
@~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Dependencies from prior plans:
@.planning/phases/06-code-display/06-01-PLAN.md
@.planning/phases/06-code-display/06-02-PLAN.md
@.planning/phases/06-code-display/06-03-PLAN.md

# Source files:
@src/claude/code_formatter.py
@src/claude/syntax_highlighter.py
@src/claude/diff_processor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DiffRenderer with overlay mode</name>
  <files>src/claude/diff_renderer.py, tests/test_diff_renderer.py</files>
  <action>
Create DiffRenderer class following TDD:

**RED - Write failing tests first:**
1. Test: render() uses emoji markers (âž• for added, âž– for removed, â‰ˆ for context)
2. Test: render() integrates CodeFormatter for width constraints
3. Test: render() integrates SyntaxHighlighter for colored code
4. Test: render() shows context lines (unchanged code around changes)
5. Test: render() handles multi-hunk diffs (multiple change locations in same file)
6. Test: render() handles multi-file diffs (separate sections per file)
7. Test: render() collapses large context (show 3 lines before/after changes, "..." for rest)
8. Test: render() handles edge cases (no context, very long lines, binary files)

**GREEN - Implement to pass:**
```python
from src.claude.code_formatter import CodeFormatter
from src.claude.syntax_highlighter import SyntaxHighlighter
from src.claude.diff_processor import FileDiff, DiffHunk
from typing import List

class DiffRenderer:
    """Render diffs in mobile-friendly overlay format."""

    # Emoji markers for mobile visual distinction
    ADDED_MARKER = "âž•"
    REMOVED_MARKER = "âž–"
    CONTEXT_MARKER = "â‰ˆ"
    CONTEXT_LINES = 3  # Lines of context before/after changes
    COLLAPSED_MARKER = "  ... ({n} lines unchanged)"

    def __init__(self):
        self.formatter = CodeFormatter()
        self.highlighter = SyntaxHighlighter()

    def render(self, file_diffs: List[FileDiff], language: str = None) -> str:
        """Render diffs for mobile display."""
        if not file_diffs:
            return "No changes to display"

        sections = []
        for file_diff in file_diffs:
            if file_diff.is_binary:
                sections.append(f"ðŸ“„ {file_diff.new_path} (binary file changed)")
                continue

            # File header
            header = f"ðŸ“„ {file_diff.new_path}"
            sections.append(header)

            # Render each hunk
            for hunk in file_diff.hunks:
                hunk_text = self._render_hunk(hunk, language)
                sections.append(hunk_text)

        return "\n\n".join(sections)

    def _render_hunk(self, hunk: DiffHunk, language: str = None) -> str:
        """Render a single hunk with context collapse."""
        lines = []
        context_buffer = []

        for line in hunk.lines:
            if line.startswith('+') and not line.startswith('+++'):
                # Added line - flush context, add line
                lines.extend(self._flush_context(context_buffer))
                context_buffer = []
                content = line[1:]  # Remove + prefix
                highlighted = self.highlighter.highlight(content, language)
                formatted = self.formatter.format_code(highlighted, language)
                lines.append(f"{self.ADDED_MARKER} {formatted}")

            elif line.startswith('-') and not line.startswith('---'):
                # Removed line - flush context, add line
                lines.extend(self._flush_context(context_buffer))
                context_buffer = []
                content = line[1:]  # Remove - prefix
                highlighted = self.highlighter.highlight(content, language)
                formatted = self.formatter.format_code(highlighted, language)
                lines.append(f"{self.REMOVED_MARKER} {formatted}")

            elif line.startswith(' '):
                # Context line - add to buffer
                content = line[1:]  # Remove space prefix
                context_buffer.append(content)

        # Flush remaining context
        lines.extend(self._flush_context(context_buffer, final=True))

        return "\n".join(lines)

    def _flush_context(self, buffer: List[str], final: bool = False) -> List[str]:
        """Flush context buffer with collapse logic."""
        if not buffer:
            return []

        if len(buffer) <= self.CONTEXT_LINES * 2:
            # Small context - show all
            return [f"{self.CONTEXT_MARKER} {line}" for line in buffer]

        # Large context - show first N and last N, collapse middle
        result = []
        for line in buffer[:self.CONTEXT_LINES]:
            result.append(f"{self.CONTEXT_MARKER} {line}")

        collapsed_count = len(buffer) - (self.CONTEXT_LINES * 2)
        if collapsed_count > 0:
            result.append(self.COLLAPSED_MARKER.format(n=collapsed_count))

        if not final:
            for line in buffer[-self.CONTEXT_LINES:]:
                result.append(f"{self.CONTEXT_MARKER} {line}")

        return result
```

**Why overlay mode (not side-by-side):**
- 320px screens can't fit two columns of code
- Overlay shows removed (âž–) then added (âž•) in sequence
- More readable on mobile than compressed side-by-side

**Why context collapse:**
- Diffs can have large unchanged sections (100+ lines)
- Show 3 lines before/after to give context
- Collapse middle with "... (N lines unchanged)"
- User sees changes without scrolling through unchanged code

Commit pattern:
1. `test(06-04): add failing tests for mobile diff rendering`
2. `feat(06-04): implement DiffRenderer with overlay mode`
  </action>
  <verify>pytest tests/test_diff_renderer.py::TestDiffRenderer -v passes</verify>
  <done>DiffRenderer renders diffs with emoji markers, syntax highlighting, and context collapse for 320px screens</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Mobile-optimized diff rendering with overlay layout, emoji markers, syntax highlighting, and context collapse</what-built>
  <how-to-verify>
1. Run test to generate sample diff output:
   ```bash
   pytest tests/test_diff_renderer.py::test_render_real_diff -v -s
   ```
   (Test creates sample diff and prints rendered output)

2. Verify visual appearance:
   - âž• markers clearly indicate added lines (should be green in terminal)
   - âž– markers clearly indicate removed lines (should be red in terminal)
   - â‰ˆ markers show context lines (unchanged code)
   - Syntax highlighting visible (keywords colored)
   - Lines wrap at ~50 chars (320px constraint)
   - Context collapse shows "... (N lines unchanged)" for large unchanged sections

3. Check readability on mobile:
   - Take screenshot of terminal output
   - View on phone (or resize terminal to 320px width)
   - Confirm: No horizontal scroll needed
   - Confirm: Changes visually distinct from context
   - Confirm: Code structure visible despite wrapping

4. Test with different code:
   - Python diff (def, class keywords)
   - JavaScript diff (const, function keywords)
   - Verify syntax highlighting adapts to language
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe visual issues to fix (e.g., "emojis too small", "wrapping breaks indentation", "colors hard to distinguish")</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_diff_renderer.py -v passes
- [ ] Human verified visual appearance on mobile screen size
- [ ] Emoji markers visible and distinct
- [ ] Syntax highlighting working
- [ ] No horizontal scroll needed
- [ ] Context collapse reduces noise in large diffs
</verification>

<success_criteria>
- All tasks completed
- TDD RED-GREEN-REFACTOR cycle followed for Task 1
- DiffRenderer integrates CodeFormatter, SyntaxHighlighter, DiffParser
- Overlay mode renders added/removed/context lines with emoji markers
- Context collapse implemented (show 3 lines before/after, collapse middle)
- Human verification passed (visual appearance acceptable on 320px screens)
- All tests passing (minimum 8 tests)
</success_criteria>

<output>
After completion, create `.planning/phases/06-code-display/06-04-SUMMARY.md`
</output>
