---
phase: 06-code-display
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified: [src/claude/diff_processor.py, tests/test_diff_processor.py]
autonomous: true

must_haves:
  truths:
    - "Git diffs parse into structured before/after representation"
    - "Plain-English summaries describe what changed without jargon"
  artifacts:
    - path: "src/claude/diff_processor.py"
      provides: "Diff parsing and summary generation"
      exports: ["DiffParser", "SummaryGenerator"]
      min_lines: 60
    - path: "tests/test_diff_processor.py"
      provides: "Test coverage for diff processing"
      min_lines: 50
  key_links:
    - from: "DiffParser.parse()"
      to: "Structured diff object"
      via: "git diff parsing"
      pattern: "diff.*@@|hunk|file.*change"
    - from: "SummaryGenerator.generate()"
      to: "Plain-English description"
      via: "change analysis"
      pattern: "added.*line|removed.*line|modified"
---

<objective>
Extract structured data from git diffs and generate plain-English summaries of code changes.

Purpose: Enable mobile users to understand code changes without parsing raw diff syntax.

Output: DiffParser extracts before/after from git diff, SummaryGenerator creates readable descriptions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Code formatter from Plan 01:
@.planning/phases/06-code-display/06-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DiffParser for git diff extraction</name>
  <files>src/claude/diff_processor.py, tests/test_diff_processor.py</files>
  <action>
Create DiffParser class following TDD:

**RED - Write failing tests first:**
1. Test: parse() extracts file path from diff header
2. Test: parse() identifies hunks (@@...@@ sections)
3. Test: parse() separates added lines (+ prefix) from removed lines (- prefix)
4. Test: parse() preserves context lines (no +/- prefix)
5. Test: parse() handles multiple files in single diff
6. Test: parse() handles binary file changes (skip content, note "binary file")
7. Test: parse() handles edge cases (empty diff, malformed input)

**GREEN - Implement to pass:**
```python
from dataclasses import dataclass
from typing import List

@dataclass
class DiffHunk:
    old_start: int
    old_count: int
    new_start: int
    new_count: int
    lines: List[str]  # Lines with +/- prefix preserved

@dataclass
class FileDiff:
    old_path: str
    new_path: str
    hunks: List[DiffHunk]
    is_binary: bool = False

class DiffParser:
    """Parse git diff output into structured representation."""

    def parse(self, diff_text: str) -> List[FileDiff]:
        """Parse git diff text into FileDiff objects."""
        if not diff_text:
            return []

        files = []
        current_file = None
        current_hunk = None

        for line in diff_text.split('\n'):
            # File headers: diff --git a/file b/file
            if line.startswith('diff --git'):
                if current_file:
                    files.append(current_file)
                # Extract paths from diff --git a/old b/new
                paths = line.split()
                old_path = paths[2][2:]  # Remove a/ prefix
                new_path = paths[3][2:]  # Remove b/ prefix
                current_file = FileDiff(old_path, new_path, [])
                current_hunk = None

            # Binary file marker
            elif line.startswith('Binary files'):
                if current_file:
                    current_file.is_binary = True

            # Hunk header: @@ -old_start,old_count +new_start,new_count @@
            elif line.startswith('@@'):
                if current_hunk:
                    current_file.hunks.append(current_hunk)
                # Parse @@ -10,5 +10,7 @@ optional context
                parts = line.split('@@')[1].strip().split()
                old = parts[0][1:].split(',')  # Remove - prefix
                new = parts[1][1:].split(',')  # Remove + prefix
                current_hunk = DiffHunk(
                    old_start=int(old[0]),
                    old_count=int(old[1]) if len(old) > 1 else 1,
                    new_start=int(new[0]),
                    new_count=int(new[1]) if len(new) > 1 else 1,
                    lines=[]
                )

            # Hunk content lines
            elif current_hunk and (line.startswith('+') or line.startswith('-') or line.startswith(' ')):
                current_hunk.lines.append(line)

        # Append final file/hunk
        if current_hunk:
            current_file.hunks.append(current_hunk)
        if current_file:
            files.append(current_file)

        return files
```

**What to AVOID and WHY:**
- Don't use regex for entire diff (git diff has complex multi-line structure)
- Don't assume single-file diffs (user might see multi-file changes)
- Don't parse content of binary files (no text representation)

Commit pattern:
1. `test(06-03): add failing tests for git diff parsing`
2. `feat(06-03): implement DiffParser for structured diff extraction`
  </action>
  <verify>pytest tests/test_diff_processor.py::TestDiffParser -v passes</verify>
  <done>DiffParser extracts file paths, hunks, and line changes from git diff output</done>
</task>

<task type="auto">
  <name>Task 2: Create SummaryGenerator for plain-English descriptions</name>
  <files>src/claude/diff_processor.py, tests/test_diff_processor.py</files>
  <action>
Add SummaryGenerator class following TDD:

**RED - Write failing tests first:**
1. Test: generate() describes single-file change ("Modified user.py: added 5 lines, removed 2 lines")
2. Test: generate() describes multi-file change ("Modified 3 files: user.py, auth.py, db.py")
3. Test: generate() identifies new files ("Created config.json: 20 lines")
4. Test: generate() identifies deleted files ("Deleted old_migration.sql")
5. Test: generate() describes function/class changes if detectable ("Modified User.validate() in user.py")
6. Test: generate() handles binary files ("Updated image.png (binary file)")
7. Test: generate() handles empty diff ("No changes detected")

**GREEN - Implement to pass:**
```python
class SummaryGenerator:
    """Generate plain-English summaries of code changes."""

    def generate(self, file_diffs: List[FileDiff]) -> str:
        """Create readable summary from parsed diff."""
        if not file_diffs:
            return "No changes detected"

        summaries = []

        for file_diff in file_diffs:
            if file_diff.is_binary:
                summaries.append(f"Updated {file_diff.new_path} (binary file)")
                continue

            # Detect new/deleted files
            if file_diff.old_path == "/dev/null":
                lines = self._count_added_lines(file_diff)
                summaries.append(f"Created {file_diff.new_path}: {lines} lines")
                continue

            if file_diff.new_path == "/dev/null":
                summaries.append(f"Deleted {file_diff.old_path}")
                continue

            # Modified file - count changes
            added, removed = self._count_changes(file_diff)
            changes = []
            if added:
                changes.append(f"added {added} lines")
            if removed:
                changes.append(f"removed {removed} lines")

            # Try to detect function/class changes
            modified_items = self._detect_modified_items(file_diff)
            if modified_items:
                summaries.append(
                    f"Modified {', '.join(modified_items)} in {file_diff.new_path}"
                )
            else:
                summaries.append(
                    f"Modified {file_diff.new_path}: {', '.join(changes)}"
                )

        # Format final summary
        if len(summaries) == 1:
            return summaries[0]
        else:
            return f"Modified {len(summaries)} files:\n" + "\n".join(f"  â€¢ {s}" for s in summaries)

    def _count_changes(self, file_diff: FileDiff) -> tuple[int, int]:
        """Count added and removed lines."""
        added = removed = 0
        for hunk in file_diff.hunks:
            for line in hunk.lines:
                if line.startswith('+') and not line.startswith('+++'):
                    added += 1
                elif line.startswith('-') and not line.startswith('---'):
                    removed += 1
        return added, removed

    def _count_added_lines(self, file_diff: FileDiff) -> int:
        """Count total lines in new file."""
        return sum(len(hunk.lines) for hunk in file_diff.hunks)

    def _detect_modified_items(self, file_diff: FileDiff) -> List[str]:
        """Detect modified functions/classes from diff context."""
        items = set()
        for hunk in file_diff.hunks:
            for line in hunk.lines:
                # Detect Python functions: def function_name(
                if 'def ' in line:
                    parts = line.split('def ')[1].split('(')[0]
                    items.add(f"{parts}()")
                # Detect Python classes: class ClassName:
                elif 'class ' in line:
                    parts = line.split('class ')[1].split(':')[0]
                    items.add(parts)
                # Detect JS/TS functions: function name() or name = () =>
                elif 'function ' in line or '=>' in line:
                    # Extract function name (basic heuristic)
                    if 'function ' in line:
                        parts = line.split('function ')[1].split('(')[0]
                        items.add(f"{parts}()")
        return list(items)
```

**Rationale:**
- User sees "what changed" at a glance without parsing +/- symbols
- Function/class detection helps identify what behavior changed
- Multi-file summaries show scope of change
- Plain language: "added 5 lines" not "+5 -2"

Commit pattern:
1. `test(06-03): add failing tests for plain-English summaries`
2. `feat(06-03): implement SummaryGenerator for change descriptions`
  </action>
  <verify>pytest tests/test_diff_processor.py::TestSummaryGenerator -v passes</verify>
  <done>SummaryGenerator creates readable descriptions of code changes from parsed diffs</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_diff_processor.py -v passes
- [ ] DiffParser handles multi-file git diff output
- [ ] SummaryGenerator produces readable descriptions (no +/- symbols in output)
- [ ] Edge cases handled (empty diff, binary files, new/deleted files)
</verification>

<success_criteria>
- All tasks completed
- TDD RED-GREEN-REFACTOR cycle followed
- DiffParser extracts structured data from git diff
- SummaryGenerator creates plain-English descriptions
- Handles single-file and multi-file diffs
- Detects new/deleted/modified files
- Function/class detection works for Python, JS, TS
- All tests passing (minimum 14 tests total)
</success_criteria>

<output>
After completion, create `.planning/phases/06-code-display/06-03-SUMMARY.md`
</output>
