---
phase: 06-code-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/claude/code_formatter.py, tests/test_code_formatter.py]
autonomous: true

must_haves:
  truths:
    - "Short code snippets display inline without horizontal scroll on 320px screens"
    - "Long code blocks trigger attachment mode (not sent inline)"
  artifacts:
    - path: "src/claude/code_formatter.py"
      provides: "Mobile-optimized code formatting with width constraints"
      exports: ["CodeFormatter", "LengthDetector"]
      min_lines: 50
    - path: "tests/test_code_formatter.py"
      provides: "Test coverage for formatting and length detection"
      min_lines: 40
  key_links:
    - from: "CodeFormatter.format()"
      to: "320px width constraint"
      via: "monospace char calculation"
      pattern: "max_width.*320|char.*width"
    - from: "LengthDetector.should_attach()"
      to: "threshold logic"
      via: "line count decision"
      pattern: "lines.*>.*100|attach.*threshold"
---

<objective>
Establish mobile-optimized code formatting foundation with intelligent inline vs attachment detection.

Purpose: Enable readable code display on mobile screens by constraining width and detecting when code is too long for inline display.

Output: CodeFormatter and LengthDetector classes ready for integration with SignalResponder.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Phase 3 established messaging patterns:
@.planning/phases/03-claude-integration/03-03-SUMMARY.md

# Current responder:
@src/claude/responder.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CodeFormatter with mobile width constraints</name>
  <files>src/claude/code_formatter.py, tests/test_code_formatter.py</files>
  <action>
Create CodeFormatter class following Phase 3 TDD patterns:

**RED - Write failing tests first:**
1. Test: format_code() wraps long lines at 50 chars (320px / ~6px per char = ~53 chars max for monospace)
2. Test: Preserves indentation when wrapping
3. Test: Adds continuation marker (↪) for wrapped lines
4. Test: Handles edge cases (empty code, single char per line, no wrapping needed)

**GREEN - Implement to pass:**
```python
class CodeFormatter:
    MAX_WIDTH = 50  # chars for 320px mobile screens
    CONTINUATION = " ↪ "

    def format_code(self, code: str, language: str = None) -> str:
        """Format code for mobile display with width constraints."""
        # Split into lines, wrap each line preserving indentation
        # Add continuation markers for wrapped lines
        # Return formatted string
```

**Implementation approach:**
- Calculate leading whitespace per line (preserve indentation)
- Wrap at MAX_WIDTH, insert CONTINUATION marker on next line
- Don't break mid-word if possible (find last space before MAX_WIDTH)
- Preserve empty lines (structural whitespace matters in code)

**What to AVOID and WHY:**
- Don't use textwrap.wrap() - it doesn't understand code indentation
- Don't strip whitespace - indentation is semantic in Python/YAML
- Don't break inside string literals or comments if detectable

**REFACTOR (if needed):**
- Extract wrapping logic to _wrap_line() helper if method grows
- Extract indentation detection to _get_indent() if reused

Commit pattern:
1. `test(06-01): add failing tests for mobile code formatting`
2. `feat(06-01): implement CodeFormatter with width constraints`
3. `refactor(06-01): extract wrapping helpers` (only if refactored)
  </action>
  <verify>pytest tests/test_code_formatter.py::TestCodeFormatter -v passes (all format_code tests green)</verify>
  <done>CodeFormatter formats code for 320px screens with proper wrapping and indentation preservation</done>
</task>

<task type="auto">
  <name>Task 2: Add LengthDetector for inline vs attachment decision</name>
  <files>src/claude/code_formatter.py, tests/test_code_formatter.py</files>
  <action>
Add LengthDetector class to same file (related functionality):

**RED - Write failing tests first:**
1. Test: should_attach() returns False for code < 20 lines
2. Test: should_attach() returns True for code > 100 lines
3. Test: should_attach() returns False for 20-100 lines (inline default for mid-range)
4. Test: get_display_mode() returns "inline" or "attachment"
5. Test: Handles edge cases (empty string, single line, exactly 20/100 lines)

**GREEN - Implement to pass:**
```python
class LengthDetector:
    INLINE_MAX = 20   # Max lines for inline display (from CODE-01)
    ATTACH_MIN = 100  # Min lines for forced attachment (from CODE-02)

    def should_attach(self, code: str) -> bool:
        """Determine if code should be sent as attachment vs inline."""
        lines = code.count('\n') + 1 if code else 0
        if lines > self.ATTACH_MIN:
            return True
        if lines <= self.INLINE_MAX:
            return False
        return False  # 20-100 lines: default to inline

    def get_display_mode(self, code: str) -> str:
        """Return 'inline' or 'attachment'."""
        return "attachment" if self.should_attach(code) else "inline"
```

**Rationale for mid-range (20-100 lines) defaulting to inline:**
- User can request full view with `/code full` command (Task 6)
- Better to show some context inline than force download
- Phase 6 will add code folding/truncation for mid-range

Commit pattern:
1. `test(06-01): add failing tests for length detection`
2. `feat(06-01): implement LengthDetector for inline vs attachment`
  </action>
  <verify>pytest tests/test_code_formatter.py::TestLengthDetector -v passes</verify>
  <done>LengthDetector correctly routes code to inline (<20 lines) or attachment (>100 lines) display modes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All tests pass: `pytest tests/test_code_formatter.py -v`
- [ ] No type errors: `mypy src/claude/code_formatter.py --strict` (if project uses mypy)
- [ ] CodeFormatter.format_code() handles edge cases without crashing
- [ ] LengthDetector thresholds match requirements (CODE-01: <20, CODE-02: >100)
</verification>

<success_criteria>
- All tasks completed
- TDD RED-GREEN-REFACTOR cycle followed for both classes
- Code formatting respects 320px mobile width constraint
- Length detection correctly implements <20 inline, >100 attachment thresholds
- Edge cases handled (empty code, single line, boundary values)
- All tests passing (minimum 10 tests total across both classes)
</success_criteria>

<output>
After completion, create `.planning/phases/06-code-display/06-01-SUMMARY.md`
</output>
